<% const _users=Array.isArray(users) ? users : []; const _categories=Array.isArray(categories) ? categories : []; const
  f=filters || {}; const selCategory=f.category ? String(f.category) : '' ; const selLevel=f.level || '' ; const
  selLocation=f.location || '' ; const selType=f.type || '' ; const selSearch=f.search || '' ; %>

  <h1 class="h4 mb-3">Browse Users</h1>

  <form class="row g-2 mb-3" method="GET" action="/browse">
    <div class="col-md-4">
      <input class="form-control" name="search" value="<%= selSearch %>"
        placeholder="Search name, bio, location, or skill">
    </div>
    <div class="col-md-3">
      <select class="form-select" name="category">
        <option value="">All categories</option>
        <% _categories.forEach(c=> { %>
          <option value="<%= c.id %>" <%=(selCategory===String(c.id) ? 'selected' : '' ) %>><%= c.name %>
          </option>
          <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="level">
        <option value="">All levels</option>
        <option value="beginner" <%=selLevel==='beginner' ? 'selected' : '' %>>beginner</option>
        <option value="intermediate" <%=selLevel==='intermediate' ? 'selected' : '' %>>intermediate</option>
        <option value="advanced" <%=selLevel==='advanced' ? 'selected' : '' %>>advanced</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" name="type">
        <option value="">All types</option>
        <option value="teach" <%=selType==='teach' ? 'selected' : '' %>>teach</option>
        <option value="learn" <%=selType==='learn' ? 'selected' : '' %>>learn</option>
      </select>
    </div>
    <div class="col-md-1 d-grid">
      <button class="btn btn-outline-secondary" type="submit">Apply</button>
    </div>
    <div class="col-12 col-md-auto mt-1">
      <input class="form-control" name="location" value="<%= selLocation %>" placeholder="Location (e.g. KL)">
    </div>
  </form>

  <% if (_users.length) { %>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% _users.forEach(u=> {
        const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        // Build condensed availability string
        let availSummary = '';
        if (Array.isArray(u.availabilities) && u.availabilities.length) {
        availSummary = u.availabilities.slice(0, 3).map(a => {
        const day = (typeof a.dayOfWeek === 'number') ? days[a.dayOfWeek % 7] : (a.day_of_week || '');
        const start = a.startTime || a.start_time || '';
        const end = a.endTime || a.end_time || '';
        if (start && end) {
        const startHr = parseInt(start.split(':')[0]);
        const endHr = parseInt(end.split(':')[0]);
        if (startHr < 12 && endHr <=12) return day + ' (Morning)' ; if (startHr>= 12 && startHr < 17) return day
            + ' (Afternoon)' ; if (startHr>= 17) return day + ' (Evening)';
            if (startHr <= 9 && endHr>= 17) return day + ' (All day)';
              return day;
              }
              return day;
              }).join('; ');
              if (u.availabilities.length > 3) availSummary += ` +${u.availabilities.length - 3} more`;
              }
              // Truncate bio
              const bioText = u.bio ? (u.bio.length > 120 ? u.bio.substring(0, 120) + '...' : u.bio) : '';
              %>
              <div class="col">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-body p-4">
                    <!-- Header: Image + Name/Location/Badge -->
                    <div class="d-flex align-items-center gap-3 mb-3">
                      <% if (u.profileImage) { %>
                        <img src="<%= u.profileImage %>" alt="<%= u.name %>" class="rounded-circle flex-shrink-0"
                          style="width: 70px; height: 70px; object-fit: cover; border: 3px solid #f0f0f0;">
                        <% } else { %>
                          <div
                            class="rounded-circle bg-light d-flex align-items-center justify-content-center flex-shrink-0"
                            style="width: 70px; height: 70px; border: 3px solid #f0f0f0;">
                            <i class="fas fa-user fa-2x text-muted"></i>
                          </div>
                          <% } %>
                            <div class="flex-grow-1">
                              <h5 class="card-title mb-1 fw-bold">
                                <%= u.name %>
                              </h5>
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                <% if (u.location) { %>
                                  <span class="text-muted small">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    <%= u.location %>
                                  </span>
                                  <% } %>
                                    <% if (u.warningCount>= 3) { %>
                                      <span class="badge bg-warning text-dark high-risk-badge" style="cursor: pointer;"
                                        data-user-name="<%= u.name %>">
                                        <i class="fas fa-exclamation-triangle me-1"></i>High-risk
                                      </span>
                                      <% } %>
                              </div>
                            </div>
                    </div>

                    <!-- Bio -->
                    <% if (bioText) { %>
                      <p class="text-secondary mb-3" style="font-size: 0.9rem; line-height: 1.5;">
                        <%= bioText %>
                      </p>
                      <% } %>

                        <!-- Skills Row -->
                        <% if (Array.isArray(u.userSkills) && u.userSkills.length) { %>
                          <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
                            <span class="text-muted small"><i class="fas fa-tags me-1"></i>Skills:</span>
                            <% u.userSkills.slice(0, 2).forEach(us=> { %>
                              <span
                                class="badge border rounded-pill <%= us.type === 'teach' ? 'border-success text-success' : 'border-primary text-primary' %>"
                                style="font-weight: 500;">
                                <%= us.type==='teach' ? 'Teaching' : 'Learning' %>: <%= us.Skill ? us.Skill.name : '' %>
                              </span>
                              <% }) %>
                                <% if (u.userSkills.length> 2) { %>
                                  <span class="badge border rounded-pill border-secondary text-secondary"
                                    style="font-weight: 500;">
                                    +<%= u.userSkills.length - 2 %> more...
                                  </span>
                                  <% } %>
                          </div>
                          <% } %>

                            <!-- Availability Row -->
                            <% if (availSummary) { %>
                              <div class="d-flex align-items-center gap-2 mb-3">
                                <span class="text-muted small"><i
                                    class="far fa-calendar-alt me-1"></i>Availability:</span>
                                <span class="text-dark small">
                                  <%= availSummary %>
                                </span>
                              </div>
                              <% } %>
                  </div>

                  <!-- Footer Actions -->
                  <div class="card-footer bg-white border-top-0 px-4 pb-4 pt-0">
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-outline-secondary btn-sm js-tip" data-user-id="<%= u.id %>"
                        data-user-name="<%= u.name %>">
                        <i class="far fa-heart me-1"></i>Tip
                      </button>
                      <% if (u.whatsapp_number || u.whatsappNumber) { %>
                        <a class="btn btn-outline-secondary btn-sm" rel="noopener"
                          href="/go/wa/<%= u.id %>?text=<%- encodeURIComponent('Hi, I saw you on SkillSwap MY!') %>"
                          target="_blank">
                          <i class="fab fa-whatsapp me-1"></i>WhatsApp
                        </a>
                        <% } %>
                          <a class="btn btn-primary btn-sm ms-auto" href="/browse/user/<%= u.id %>">
                            VIEW PROFILE <i class="fas fa-chevron-right ms-1"></i>
                          </a>
                    </div>
                  </div>
                </div>
              </div>
              <% }) %>
    </div>

    <%# Pagination %>
      <% if (typeof pagination !=='undefined' && pagination) { %>
        <%- include('../partials/pagination', pagination) %>
          <% } %>
            <% } else { %>
              <div class="alert alert-info">No users match your filters.</div>
              <% } %>

                <script>
                  document.addEventListener('DOMContentLoaded', function () {
                    document.querySelectorAll('.high-risk-badge').forEach(badge => {
                      badge.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const userName = this.dataset.userName || 'This user';
                        Swal.fire({
                          icon: 'warning',
                          title: 'High-Risk Account',
                          html: `<p><strong>${userName}</strong> has been flagged as a high-risk account due to multiple community guideline violations.</p>
               <p class="text-muted small">Please exercise caution when interacting with this user. Consider reviewing their profile and ratings carefully before engaging.</p>`,
                          confirmButtonText: 'I Understand',
                          confirmButtonColor: '#dc3545'
                        });
                      });
                    });
                  });
                </script>