<div class="container py-4">
  <div class="row g-4">
    <!-- Main Form Column -->
    <div class="col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 fw-bold text-gray-800">Create New Listing</h1>
      </div>

      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body p-4">
          <form method="POST" action="/listings/create" class="row g-4 needs-validation" novalidate>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">

            <!-- Title -->
            <div class="col-12">
              <label class="form-label fw-semibold">Listing Title</label>
              <input class="form-control form-control-lg" name="title" required maxlength="255"
                value="<%= (form && form.title) || (aiRewrite && aiRewrite.title) || '' %>"
                placeholder="e.g., I can teach you Advanced Python Programming">
              <div class="form-text">Be specific and catchy.</div>
            </div>

            <!-- Description -->
            <div class="col-12">
              <label class="form-label fw-semibold">Description</label>
              <textarea class="form-control" name="description" rows="6" required
                placeholder="Describe what you are offering and what you hope to learn in return..."><%= (form && form.description) || (aiRewrite && aiRewrite.description) || '' %></textarea>
            </div>

            <!-- Skill Exchange Section -->
            <div class="col-12">
              <div class="card bg-light border-0 rounded-3">
                <div
                  class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pb-0 pt-3 px-3">
                  <span class="fw-bold text-dark"><i class="fas fa-exchange-alt me-2 text-primary"></i>Skill
                    Exchange</span>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="emphasisToggle">
                    <label class="form-check-label small text-muted" for="emphasisToggle">Emphasize learning</label>
                  </div>
                </div>
                <div class="card-body p-3">
                  <div class="row g-3">
                    <!-- Teach Section -->
                    <div class="col-md-6 order-md-1" id="teachSection">
                      <label class="form-label fw-bold text-success small text-uppercase ls-1">
                        <i class="fas fa-chalkboard-teacher me-1"></i><span id="teachLabel">I Will Teach</span>
                      </label>
                      <div class="input-group">
                        <select class="form-select" name="skill_id" required>
                          <option value="">Select a skill...</option>
                          <% if (!Array.isArray(teachSkills) || teachSkills.length===0) { %>
                            <option value="" disabled>No teaching skills found.</option>
                            <% } else { %>
                              <% teachSkills.forEach(s=> { %>
                                <option value="<%= s.id %>" <%=(form && String(form.skill_id)===String(s.id))
                                  ? 'selected' : '' %>>
                                  <%= s.name %>
                                </option>
                                <% }) %>
                                  <% } %>
                        </select>
                      </div>
                      <div class="mt-2 text-end">
                        <button type="button" class="btn btn-sm btn-link text-decoration-none p-0"
                          id="generateTeachSuggestions" onclick="triggerAiSuggestions('teach')" data-bs-toggle="tooltip"
                          title="Select a skill first to get AI suggestions">
                          <i class="fas fa-magic me-1"></i>AI Suggestions
                        </button>
                      </div>
                    </div>

                    <!-- Learn Section -->
                    <div class="col-md-6 order-md-2" id="learnSection">
                      <label class="form-label fw-bold text-primary small text-uppercase ls-1">
                        <i class="fas fa-graduation-cap me-1"></i><span id="learnLabel">I Want to Learn</span>
                      </label>
                      <div class="input-group">
                        <select class="form-select" name="learn_skill_id" required>
                          <option value="">Select a skill...</option>
                          <% if (Array.isArray(learnSkills) && learnSkills.length> 0) { %>
                            <% learnSkills.forEach(s=> { %>
                              <option value="<%= s.id %>" <%=(form && String(form.learn_skill_id)===String(s.id))
                                ? 'selected' : '' %>>
                                <%= s.name %>
                              </option>
                              <% }) %>
                                <% } %>
                        </select>
                      </div>
                      <div class="mt-2 text-end">
                        <button type="button" class="btn btn-sm btn-link text-decoration-none p-0"
                          id="generateLearnSuggestions" onclick="triggerAiSuggestions('learn')" data-bs-toggle="tooltip"
                          title="Select a skill first to get AI suggestions">
                          <i class="fas fa-magic me-1"></i>AI Suggestions
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Visibility -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Visibility</label>
              <select class="form-select" name="visibility">
                <option value="public" <%=(!form || form.visibility==='public' ) ? 'selected' : '' %> >Public (Visible
                  to everyone)</option>
                <option value="private" <%=(form && form.visibility==='private' ) ? 'selected' : '' %> >Private (Only
                  me)</option>
              </select>
            </div>

            <!-- Action Buttons -->
            <div class="col-12 mt-4">
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a class="btn btn-light px-4" href="/listings">Cancel</a>
                <button class="btn btn-primary px-4" type="submit"><i class="fas fa-paper-plane me-2"></i>Publish
                  Listing</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Mobile Live Preview Accordion -->
      <div class="d-lg-none mt-4">
        <div class="accordion shadow-sm rounded-3 overflow-hidden" id="mobilePreviewAccordion">
          <div class="accordion-item border-0">
            <h2 class="accordion-header" id="mobilePreviewHeader">
              <button class="accordion-button collapsed fw-bold bg-white" type="button" data-bs-toggle="collapse"
                data-bs-target="#mobilePreviewCollapse" aria-expanded="false" aria-controls="mobilePreviewCollapse">
                <i class="fas fa-eye me-2 text-primary"></i>Live Preview
              </button>
            </h2>
            <div id="mobilePreviewCollapse" class="accordion-collapse collapse" aria-labelledby="mobilePreviewHeader"
              data-bs-parent="#mobilePreviewAccordion">
              <div class="accordion-body bg-light">
                <!-- Mobile Preview Content -->
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <h6 class="fw-bold mb-1" id="mobilePreviewTitle">Your listing title...</h6>
                    <p class="text-muted small mb-2" id="mobilePreviewDescription">Your description...</p>
                    <div class="d-flex flex-wrap gap-1">
                      <span class="badge bg-success">Teaching</span>
                      <span class="badge bg-light text-dark border" id="mobilePreviewSkill">Skill</span>
                      <span class="badge bg-primary d-none" id="mobilePreviewLearnSkill"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Suggestions Container (Client-side rendered) -->
      <div class="card shadow-sm border-0 rounded-3 mt-4 d-none" id="aiSuggestionsCard">
        <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center pt-3 px-3">
          <span class="fw-bold text-primary"><i class="fas fa-robot me-2"></i>AI Suggestions</span>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="regenerateSuggestions">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" id="saveSuggestion">
              <i class="fas fa-bookmark"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" id="loadSavedSuggestions">
              <i class="fas fa-history"></i>
            </button>
          </div>
        </div>
        <div class="card-body pt-0" id="suggestionsContent">
          <!-- Content will be loaded here -->
        </div>
      </div>

    </div>

    <!-- Sidebar Column (Preview) -->
    <div class="col-lg-4 d-none d-lg-block">
      <div class="sticky-top" style="top: 2rem; z-index: 10;">
        <h6 class="text-uppercase text-muted fw-bold small ls-1 mb-3">Live Preview</h6>

        <!-- Preview Card -->
        <div class="card border-0 shadow-sm" id="listingPreview">
          <div class="card-header bg-primary text-white border-0 py-3">
            <div class="d-flex justify-content-between align-items-start">
              <h6 class="mb-0 fw-bold text-truncate pe-2" id="previewTitle" style="max-width: 80%;">Your Title</h6>
              <span class="badge bg-success" id="previewVisibility">Public</span>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex flex-wrap gap-2 mb-2" id="previewBadges">
                <span class="badge bg-success" id="badgeTeachingLabel">Teaching</span>
                <span class="badge bg-light text-dark border" id="previewSkill">Skill</span>
                <span class="badge bg-primary d-none" id="previewLearnSkill"></span>
              </div>
            </div>
            <p class="card-text text-muted small" id="previewDescription">Your description will appear here...</p>
          </div>
          <div class="card-footer bg-white border-top-0 pt-0 pb-3">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted"><i class="fas fa-user-circle me-1"></i>You</small>
              <button class="btn btn-sm btn-outline-primary disabled">Contact</button>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 small border-0 bg-info-subtle text-info-emphasis">
          <i class="fas fa-info-circle me-2"></i>This is how your listing will appear to others.
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Listing Preview Modal (Optional now since we have live preview, but good for mobile final check) -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Listing Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Duplicate of preview card logic could go here if needed, but we rely on live preview mostly -->
        <p>Please review your listing details before submitting.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit</button>
        <button type="button" class="btn btn-primary" onclick="submitForm()">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- Saved Suggestions Modal -->
<div class="modal fade" id="savedSuggestionsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">Saved Suggestions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
          <button class="btn btn-sm btn-outline-primary active rounded-pill px-3"
            onclick="loadSuggestions('all')">All</button>
          <button class="btn btn-sm btn-outline-primary rounded-pill px-3"
            onclick="loadSuggestions('teach')">Teaching</button>
          <button class="btn btn-sm btn-outline-primary rounded-pill px-3"
            onclick="loadSuggestions('learn')">Learning</button>
          <button class="btn btn-sm btn-outline-warning rounded-pill px-3" onclick="loadSuggestions('favorites')">
            <i class="fas fa-star me-1"></i>Favorites
          </button>
        </div>

        <div id="savedSuggestionsList" class="vstack gap-3">
          <div class="text-center text-muted py-5">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Loading suggestions...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if (typeof moderationFlagged !=='undefined' && moderationFlagged) { %>
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div class="toast show align-items-center text-white bg-warning border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <%= moderationFlagged.message %>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>
  <% } %>

    <script>
      // Pass server-side data to the external script
      window.listingData = {
        teachSkillsData: JSON.parse(String.raw`<%- JSON.stringify(
          Array.isArray(teachSkills)
          ? Object.fromEntries(teachSkills.map(skill => [String(skill.id), skill.name]))
          : {}
        ) %>`),
        learnSkillsData: JSON.parse(String.raw`<%- JSON.stringify(
          Array.isArray(learnSkills)
          ? Object.fromEntries(learnSkills.map(skill => [String(skill.id), skill.name]))
          : {}
        ) %>`),
        serverSuggestions: JSON.parse(String.raw`<%- JSON.stringify(typeof aiSuggestions !== 'undefined' ? aiSuggestions : null) %>`)
      };
    </script>
    <script src="/js/listing-form.js"></script>