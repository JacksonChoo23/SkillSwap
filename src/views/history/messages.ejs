<div class="container py-4">
  <h1 class="mb-4">Notification</h1>

  <ul class="nav nav-tabs" id="notificationTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="new-notifications-tab" data-bs-toggle="tab"
        data-bs-target="#new-notifications" type="button" role="tab" aria-controls="new-notifications"
        aria-selected="true">New Notifications</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab"
        aria-controls="history" aria-selected="false">History</button>
    </li>
  </ul>
  <div class="tab-content" id="notificationTabsContent">
    <div class="tab-pane fade show active" id="new-notifications" role="tabpanel"
      aria-labelledby="new-notifications-tab">
      <p>Loading new notifications...</p>
    </div>
    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
      <p>Loading notification history...</p>
    </div>
  </div>
</div>

<div class="container py-4">
  <h1 class="mb-4">Message History</h1>

  <% if (!rows || rows.length===0) { %>
    <div class="alert alert-info">
      No WhatsApp contacts yet.<br />
      在用户资料页点击 WhatsApp 开始联系，这里会自动记录。
    </div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>WhatsApp</th>
              <th>First</th>
              <th>Last</th>
              <th>Count</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% rows.forEach(r=> { %>
              <tr>
                <td><a href="/browse/user/<%= r.peer.id %>">
                    <%= r.peer.name %>
                  </a></td>
                <td>
                  <%= r.peer.whatsapp_number || '-' %>
                </td>
                <td>
                  <%= new Date(r.firstContactedAt).toLocaleString() %>
                </td>
                <td>
                  <%= new Date(r.lastContactedAt).toLocaleString() %>
                </td>
                <td>
                  <%= r.count %>
                </td>
                <td class="d-flex gap-2">
                  <a class="btn btn-success btn-sm" href="/go/wa/<%= r.peer.id %>?text=<%- encodeURIComponent('Hi!') %>"
                    target="_blank" rel="noopener">WhatsApp</a>
                  <button class="btn btn-outline-danger btn-sm delete-message-btn"
                    data-message-id="<%= r.id %>">Delete</button>
                </td>
              </tr>
              <% }) %>
          </tbody>
        </table>
      </div>
      <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmDelete(id) {
    Swal.fire({
      title: 'Are you sure?',
      text: 'This action cannot be undone.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!',
      position: 'center'
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/history/messages/${id}/delete`;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = '<%= csrfToken %>';
        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
      }
    });
  }

  // Add event listeners for delete buttons
  document.addEventListener('DOMContentLoaded', function () {
    // Attach event listeners to delete buttons
    document.querySelectorAll('.delete-message-btn').forEach(button => {
      button.addEventListener('click', function () {
        const messageId = this.getAttribute('data-message-id');
        confirmDelete(messageId);
      });
    });

    // Load notifications
    loadNotifications();
  });

  async function loadNotifications() {
    try {
      const newNotificationsResponse = await fetch('/listings/api/notifications?status=new');
      const newNotifications = await newNotificationsResponse.json();

      const historyResponse = await fetch('/listings/api/notifications?status=history');
      const historyNotifications = await historyResponse.json();

      const newNotificationsContainer = document.getElementById('new-notifications');
      const historyContainer = document.getElementById('history');

      newNotificationsContainer.innerHTML = newNotifications.length
        ? newNotifications.map(n => `<p>${n.message}</p>`).join('')
        : '<p>No new notifications.</p>';

      historyContainer.innerHTML = historyNotifications.length
        ? historyNotifications.map(n => `<p>${n.message}</p>`).join('')
        : '<p>No notification history.</p>';
    } catch (error) {
      console.error('Error loading notifications:', error);
    }
  }


</script>