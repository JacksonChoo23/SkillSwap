<div class="container py-4">
  <h1 class="mb-4">Message History</h1>

  <% if (!rows || rows.length === 0) { %>
    <div class="alert alert-info">
      No WhatsApp contacts yet.<br/>
      在用户资料页点击 WhatsApp 开始联系，这里会自动记录。
    </div>
  <% } else { %>
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>WhatsApp</th>
            <th>First</th>
            <th>Last</th>
            <th>Count</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% rows.forEach(r => { %>
            <tr>
              <td><a href="/browse/user/<%= r.peer.id %>"><%= r.peer.name %></a></td>
              <td><%= r.peer.whatsapp_number || '-' %></td>
              <td><%= new Date(r.firstContactedAt).toLocaleString() %></td>
              <td><%= new Date(r.lastContactedAt).toLocaleString() %></td>
              <td><%= r.count %></td>
              <td class="d-flex gap-2">
                <a class="btn btn-success btn-sm" href="/go/wa/<%= r.peer.id %>?text=<%- encodeURIComponent('Hi!') %>" target="_blank" rel="noopener">WhatsApp</a>
                <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete('<%= r.id %>')">Delete</button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmDelete(id) {
    Swal.fire({
      title: 'Are you sure?',
      text: 'This action cannot be undone.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/history/messages/${id}/delete`;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = '<%= csrfToken %>';
        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>


