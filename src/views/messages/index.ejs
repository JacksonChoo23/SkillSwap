<% const me=user || {}; const items=Array.isArray(threads) ? threads : []; %>

  <!-- Page Header -->
  <div class="container py-4">
    <div class="row mb-4">
      <div class="col">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
          <div>
            <h1 class="h3 mb-1">
              <i class="fas fa-comments text-primary me-2"></i>Messages
            </h1>
            <p class="text-muted mb-0 small">Your conversations with other users</p>
          </div>
          <% if (items.length> 0) { %>
            <div class="d-flex gap-2">
              <div class="input-group" style="max-width: 280px;">
                <span class="input-group-text bg-white border-end-0">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-start-0" id="searchConversations"
                  placeholder="Search conversations...">
              </div>
            </div>
            <% } %>
        </div>
      </div>
    </div>

    <% if (items.length===0) { %>
      <!-- Empty State -->
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="mb-4">
            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center"
              style="width: 100px; height: 100px;">
              <i class="fas fa-comments fa-3x text-muted"></i>
            </div>
          </div>
          <h4 class="text-dark mb-2">No conversations yet</h4>
          <p class="text-muted mb-4">
            Start connecting with other users to exchange skills and knowledge.<br>
            Browse users and click "Message" on their profile to start a conversation.
          </p>
          <a href="/browse" class="btn btn-primary">
            <i class="fas fa-users me-2"></i>Browse Users
          </a>
        </div>
      </div>
      <% } else { %>

        <!-- Conversations List -->
        <div class="card border-0 shadow-sm">
          <div class="list-group list-group-flush" id="conversationsList">
            <% items.forEach((t, index)=> {
              const partner = (t.creatorId === me.id) ? t.participant : t.creator;
              const partnerName = partner?.name || 'Unknown User';
              const partnerImage = partner?.profileImage || null;
              const listingTitle = t.Listing?.title || null;
              const lastMessage = (t.messages && t.messages.length > 0) ? t.messages[0] : null;
              const lastMessageText = lastMessage ? lastMessage.content : 'No messages yet';
              const updatedAt = new Date(t.updatedAt);
              %>
              <a href="/messages/thread/<%= t.id %>"
                class="list-group-item list-group-item-action py-3 conversation-item"
                data-partner-name="<%= partnerName.toLowerCase() %>"
                data-listing-title="<%= listingTitle ? listingTitle.toLowerCase() : '' %>">
                <div class="d-flex align-items-start gap-3">
                  <!-- Partner Avatar -->
                  <div class="flex-shrink-0 position-relative">
                    <% if (partnerImage) { %>
                      <img src="<%= partnerImage %>" alt="<%= partnerName %>" class="rounded-circle border"
                        style="width: 56px; height: 56px; object-fit: cover;">
                      <% } else { %>
                        <div
                          class="rounded-circle bg-primary bg-gradient d-flex align-items-center justify-content-center text-white"
                          style="width: 56px; height: 56px; font-size: 1.25rem;">
                          <%= partnerName.charAt(0).toUpperCase() %>
                        </div>
                        <% } %>
                  </div>

                  <!-- Conversation Content -->
                  <div class="flex-grow-1 min-width-0">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                      <h6 class="mb-0 fw-semibold text-dark">
                        <%= partnerName %>
                      </h6>
                      <small class="text-muted flex-shrink-0 ms-2" data-timestamp="<%= updatedAt.toISOString() %>">
                        <%= updatedAt.toLocaleDateString() %>
                      </small>
                    </div>

                    <% if (listingTitle) { %>
                      <div class="mb-1">
                        <span class="badge bg-primary bg-opacity-10 text-primary fw-normal">
                          <i class="fas fa-tag me-1"></i>
                          <%= listingTitle %>
                        </span>
                      </div>
                      <% } %>

                        <p class="mb-0 text-muted small text-truncate" style="max-width: 100%;">
                          <% if (lastMessage) { %>
                            <% if (lastMessage.senderId===me.id) { %>
                              <span class="text-primary">You: </span>
                              <% } %>
                                <%= lastMessageText.substring(0, 80) %>
                                  <%= lastMessageText.length> 80 ? '...' : '' %>
                                    <% } else { %>
                                      <em>No messages yet</em>
                                      <% } %>
                        </p>
                  </div>

                  <!-- Arrow Indicator -->
                  <div class="flex-shrink-0 align-self-center">
                    <i class="fas fa-chevron-right text-muted"></i>
                  </div>
                </div>
              </a>
              <% }) %>
          </div>
        </div>

        <!-- No Results Message (hidden by default) -->
        <div class="card border-0 shadow-sm d-none" id="noSearchResults">
          <div class="card-body text-center py-5">
            <i class="fas fa-search fa-2x text-muted mb-3"></i>
            <h5 class="text-muted">No conversations found</h5>
            <p class="text-muted small mb-0">Try a different search term</p>
          </div>
        </div>
        <% } %>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Relative time formatting
      function getRelativeTime(date) {
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (seconds < 60) return 'Just now';
        if (minutes < 60) return minutes + ' min ago';
        if (hours < 24) return hours + 'h ago';
        if (days === 1) return 'Yesterday';
        if (days < 7) return days + ' days ago';
        return date.toLocaleDateString();
      }

      // Update all timestamps to relative time
      document.querySelectorAll('[data-timestamp]').forEach(el => {
        const timestamp = new Date(el.dataset.timestamp);
        el.textContent = getRelativeTime(timestamp);
      });

      // Search functionality
      const searchInput = document.getElementById('searchConversations');
      const conversationsList = document.getElementById('conversationsList');
      const noResultsCard = document.getElementById('noSearchResults');

      if (searchInput && conversationsList) {
        searchInput.addEventListener('input', function () {
          const searchTerm = this.value.toLowerCase().trim();
          const items = conversationsList.querySelectorAll('.conversation-item');
          let visibleCount = 0;

          items.forEach(item => {
            const partnerName = item.dataset.partnerName || '';
            const listingTitle = item.dataset.listingTitle || '';
            const matches = partnerName.includes(searchTerm) || listingTitle.includes(searchTerm);

            item.style.display = matches ? '' : 'none';
            if (matches) visibleCount++;
          });

          // Show/hide no results message
          if (noResultsCard) {
            if (visibleCount === 0 && searchTerm.length > 0) {
              conversationsList.parentElement.classList.add('d-none');
              noResultsCard.classList.remove('d-none');
            } else {
              conversationsList.parentElement.classList.remove('d-none');
              noResultsCard.classList.add('d-none');
            }
          }
        });
      }
    });
  </script>