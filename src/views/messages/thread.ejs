<% const me=user || {}; const t=thread || {}; const msgs=Array.isArray(t.messages) ? t.messages : []; const
  partner=(t.creatorId===me.id) ? t.participant : t.creator; const partnerName=partner?.name || 'Partner' ; const
  listingTitle=t.Listing?.title || null; const csrf=csrfToken || '' ; %>

  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-3">
      <a class="btn btn-outline-secondary btn-sm" href="/messages">
        <i class="fas fa-arrow-left me-1"></i>Back
      </a>
      <% if (listingTitle) { %>
        <h1 class="h5 d-inline align-middle mb-0">
          <%= listingTitle %>
        </h1>
        <span class="text-muted ms-2">with <strong>
            <%= partnerName %>
          </strong></span>
        <% } else { %>
          <h1 class="h5 d-inline align-middle mb-0">Chat with <strong>
              <%= partnerName %>
            </strong></h1>
          <% } %>
    </div>
    <div class="d-flex gap-2">
      <% if (partner && partner.whatsappNumber) { %>
        <a class="btn btn-success btn-sm" target="_blank" rel="noopener"
          href="https://wa.me/<%= encodeURIComponent((partner.whatsappNumber || '').replace(/\+/g,'').trim()) %>?text=<%= encodeURIComponent('Hi I saw you on SkillSwap MY') %>">WhatsApp</a>
        <% } %>
          <% if (partner) { %>
            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
              data-bs-target="#reportModal">Report</button>

            <!-- Report Modal -->
            <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Report User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <form action="/reports" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                      <input type="hidden" name="_csrf" value="<%= csrf %>">
                      <input type="hidden" name="targetUserId" value="<%= partner.id %>">

                      <div class="mb-3">
                        <label class="form-label">Why are you reporting this user?</label>
                        <textarea class="form-control" name="reason" rows="3" required minlength="10"
                          placeholder="Please describe the issue..."></textarea>
                      </div>

                      <!-- Chat Evidence Section -->
                      <div class="mb-3">
                        <label class="form-label fw-bold">Chat Evidence (Optional)</label>
                        <p class="small text-muted mb-2">Select messages to include as evidence:</p>

                        <div class="border rounded p-2 bg-light mb-2" style="max-height: 200px; overflow-y: auto;">
                          <% if (msgs.length> 0) { %>
                            <% msgs.slice(-10).forEach(m=> { %>
                              <div class="form-check mb-1">
                                <input class="form-check-input evidence-check" type="checkbox" name="chatMessageIds[]"
                                  value="<%= m.id %>" id="msg<%= m.id %>">
                                <label class="form-check-label small" for="msg<%= m.id %>">
                                  <strong>
                                    <%= m.senderId===me.id ? 'You' : partnerName %>:
                                  </strong>
                                  <%= m.content.substring(0, 50) %>
                                    <%= m.content.length> 50 ? '...' : '' %>
                                      <span class="text-muted" style="font-size: 0.75em;">(<%= new
                                          Date(m.createdAt).toLocaleTimeString() %>)</span>
                                </label>
                                <!-- Hidden input to send actual content if checked -->
                                <input type="hidden" name="chatContent_<%= m.id %>" value="<%= m.content %>">
                                <input type="hidden" name="chatSender_<%= m.id %>"
                                  value="<%= m.senderId === me.id ? 'You' : partnerName %>">
                                <input type="hidden" name="chatTime_<%= m.id %>"
                                  value="<%= new Date(m.createdAt).toISOString() %>">
                              </div>
                              <% }) %>
                                <% } else { %>
                                  <p class="small text-muted fst-italic">No recent messages to attach.</p>
                                  <% } %>
                        </div>

                        <div class="alert alert-warning py-2 mb-0" style="font-size: 0.85rem;">
                          <i class="fas fa-exclamation-triangle me-1"></i>
                          <strong>Privacy Warning:</strong> By attaching these messages, you consent to sharing this
                          private conversation with SkillSwap admins for review.
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Attach Screenshots (Optional)</label>
                        <input type="file" class="form-control form-control-sm" name="evidence" multiple
                          accept="image/*">
                      </div>

                      <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" required id="privacyConsent">
                        <label class="form-check-label small" for="privacyConsent">
                          I agree to share the selected information for investigation purposes.
                        </label>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-danger">Submit Report</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <% } %>
              <% if (t.Listing?.id) { %>
                <a class="btn btn-outline-secondary btn-sm" href="/listings/<%= t.Listing.id %>">View listing</a>
                <% } %>
    </div>
  </div>

  <div class="card">
    <div class="card-body" style="max-height: 60vh; overflow:auto;" id="chatScroll">
      <% if (msgs.length===0) { %>
        <div class="text-muted small">No messages yet.</div>
        <% } else { %>
          <div class="vstack gap-3">
            <% msgs.forEach(m=> {
              const mine = m.senderId === me.id;
              %>
              <div class="d-flex <%= mine ? 'justify-content-end' : 'justify-content-start' %>">
                <div class="p-2 rounded <%= mine ? 'bg-primary text-white' : 'bg-light' %>" style="max-width: 75%;">
                  <div class="small <%= mine ? 'text-white-50' : 'text-muted' %> mb-1">
                    <%= m.sender?.name || (mine ? 'You' : 'User' ) %> • <%= new Date(m.createdAt).toLocaleString() %>
                  </div>
                  <div style="white-space: pre-wrap;">
                    <%= m.content %>
                  </div>
                </div>
              </div>
              <% }) %>
          </div>
          <% } %>
            <div id="chatEnd"></div>
    </div>
    <div class="card-footer">
      <form id="messageForm">
        <input type="hidden" name="_csrf" value="<%= csrf %>">
        <div class="input-group">
          <textarea class="form-control" name="content" id="messageInput" rows="2" required
            placeholder="Type your message..."></textarea>
          <button class="btn btn-primary" type="submit" id="sendBtn">Send</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const chatScroll = document.getElementById('chatScroll');
    const chatEnd = document.getElementById('chatEnd');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // Auto-scroll to latest
    if (chatEnd) chatEnd.scrollIntoView({ behavior: 'instant', block: 'end' });

    // Socket.io real-time messaging
    const socket = io();
    const threadId = '<%= t.id %>';
    const myId = <%= me.id %>;
    const myName = '<%= me.name %>';
    const csrfToken = '<%= csrf %>';

    // Join the thread room
    socket.emit('join_thread', threadId);

    // Function to add a message bubble
    function addMessageBubble(data, isMine) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'd-flex ' + (isMine ? 'justify-content-end' : 'justify-content-start');

      const bubble = document.createElement('div');
      bubble.className = 'p-2 rounded ' + (isMine ? 'bg-primary text-white' : 'bg-light');
      bubble.style.maxWidth = '75%';

      const header = document.createElement('div');
      header.className = 'small ' + (isMine ? 'text-white-50' : 'text-muted') + ' mb-1';
      header.textContent = data.senderName + ' • ' + new Date(data.createdAt).toLocaleString();

      const content = document.createElement('div');
      content.style.whiteSpace = 'pre-wrap';
      content.textContent = data.content;

      bubble.appendChild(header);
      bubble.appendChild(content);
      msgDiv.appendChild(bubble);

      // Insert into container
      let container = chatScroll.querySelector('.vstack');
      if (!container) {
        container = document.createElement('div');
        container.className = 'vstack gap-3';
        chatScroll.insertBefore(container, chatEnd);
        // Remove "No messages yet" text
        const noMsg = chatScroll.querySelector('.text-muted.small');
        if (noMsg) noMsg.remove();
      }
      container.appendChild(msgDiv);

      // Scroll to new message
      chatEnd.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    // Listen for new messages from other users
    socket.on('new_message', (data) => {
      if (data.senderId === myId) return; // Skip our own (we add it immediately)
      addMessageBubble(data, false);
    });

    // Handle form submission via AJAX
    messageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = messageInput.value.trim();
      if (!content) return;

      // Disable button while sending
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        const res = await fetch('/messages/thread/<%= t.id %>/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ content })
        });

        if (res.ok) {
          // Add our message immediately
          addMessageBubble({
            content: content,
            senderName: myName,
            createdAt: new Date().toISOString()
          }, true);
          messageInput.value = '';
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to send message');
        }
      } catch (err) {
        console.error('Send error:', err);
        alert('Failed to send message. Please try again.');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        messageInput.focus();
      }
    });

    // Send on Enter (Shift+Enter for newline)
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        messageForm.dispatchEvent(new Event('submit'));
      }
    });

    // Cleanup on page leave
    window.addEventListener('beforeunload', () => {
      socket.emit('leave_thread', threadId);
    });
  </script>