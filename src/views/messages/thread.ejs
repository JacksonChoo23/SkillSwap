<%
  const me = user || {};
  const t = thread || {};
  const msgs = Array.isArray(t.messages) ? t.messages : [];
  const partner = (t.creatorId === me.id) ? t.participant : t.creator;
  const partnerName = partner?.name || 'Partner';
  const listingTitle = t.Listing?.title || 'Listing';
  const csrf = csrfToken || '';
%>

<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
  <div>
    <a class="btn btn-link p-0 me-2" href="/messages">&larr; Back</a>
    <h1 class="h5 d-inline align-middle mb-0"><%= listingTitle %></h1>
    <span class="text-muted ms-2">with <strong><%= partnerName %></strong></span>
  </div>
  <div class="d-flex gap-2">
    <% if (partner && partner.whatsappNumber) { %>
      <a class="btn btn-success btn-sm" target="_blank" rel="noopener" href="https://wa.me/<%= encodeURIComponent((partner.whatsappNumber || '').replace(/\+/g,'').trim()) %>?text=<%= encodeURIComponent('Hi I saw you on SkillSwap MY') %>">WhatsApp</a>
    <% } %>
    <% if (partner) { %>
      <button class="btn btn-outline-danger btn-sm js-report" data-target-id="<%= partner.id %>" data-target-name="<%= partner.name %>" data-thread-id="<%= t.id %>">Report</button>
    <% } %>
    <% if (t.Listing?.id) { %>
      <a class="btn btn-outline-secondary btn-sm" href="/listings/<%= t.Listing.id %>">View listing</a>
    <% } %>
  </div>
</div>

<div class="card">
  <div class="card-body" style="max-height: 60vh; overflow:auto;" id="chatScroll">
    <% if (msgs.length === 0) { %>
      <div class="text-muted small">No messages yet.</div>
    <% } else { %>
      <div class="vstack gap-3">
        <% msgs.forEach(m => { 
             const mine = m.senderId === me.id;
        %>
          <div class="d-flex <%= mine ? 'justify-content-end' : 'justify-content-start' %>">
            <div class="p-2 rounded <%= mine ? 'bg-primary text-white' : 'bg-light' %>" style="max-width: 75%;">
              <div class="small <%= mine ? 'text-white-50' : 'text-muted' %> mb-1">
                <%= m.sender?.name || (mine ? 'You' : 'User') %> â€¢ <%= new Date(m.createdAt).toLocaleString() %>
              </div>
              <div style="white-space: pre-wrap;"><%= m.content %></div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
    <div id="chatEnd"></div>
  </div>
  <div class="card-footer">
    <form method="POST" action="/messages/thread/<%= t.id %>">
      <input type="hidden" name="_csrf" value="<%= csrf %>">
      <div class="input-group">
        <textarea class="form-control" name="content" rows="2" required placeholder="Type your message..."></textarea>
        <button class="btn btn-primary" type="submit">Send</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Auto-scroll to latest
  const el = document.getElementById('chatEnd');
  if (el) el.scrollIntoView({ behavior: 'instant', block: 'end' });
</script>
