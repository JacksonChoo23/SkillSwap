<% const u=user || {}; const userSkills=Array.isArray(u.userSkills) ? u.userSkills : []; const
  avails=Array.isArray(u.availabilities) ? u.availabilities : []; const
  DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; %>

  <div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm overflow-hidden">
          <div class="card-body p-0">
            <div class="bg-primary h-100px"></div>
            <div class="px-4 pb-4">
              <div class="d-flex align-items-end mt-n5 mb-3">
                <div class="position-relative">
                  <% if (u.profileImage) { %>
                    <img src="<%= u.profileImage %>" alt="<%= u.name %>"
                      class="rounded-circle border border-4 border-white shadow-sm"
                      style="width: 120px; height: 120px; object-fit: cover;">
                    <% } else { %>
                      <div
                        class="rounded-circle border border-4 border-white shadow-sm bg-light d-flex align-items-center justify-content-center text-secondary"
                        style="width: 120px; height: 120px; font-size: 3rem;">
                        <i class="fas fa-user"></i>
                      </div>
                      <% } %>
                </div>
                <div class="ms-3 mb-2">
                  <h1 class="h3 mb-0">
                    <%= u.name || 'User' %>
                  </h1>
                  <div class="text-muted small">
                    <%= u.email %>
                  </div>
                </div>
                <div class="ms-auto mb-2 d-none d-md-block">
                  <a class="btn btn-outline-primary" href="/profile/progress/export">
                    <i class="fas fa-download me-1"></i> Export Progress
                  </a>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-3 align-items-center">
                <% if (u.location) { %>
                  <div class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>
                    <%= u.location %>
                  </div>
                  <% } %>
                    <div class="text-muted"><i class="fas fa-id-badge me-1"></i>ID: <%= u.id %>
                    </div>
                    <span
                      class="badge <%= u.isPublic ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary' %> border <%= u.isPublic ? 'border-success-subtle' : 'border-secondary-subtle' %>">
                      <%= u.isPublic ? 'Public Profile' : 'Private Profile' %>
                    </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left Column: Stats & Skills -->
      <div class="col-12 col-lg-4">
        <!-- Progress Stats -->
        <% if (progressSummary) { %>
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
              <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>Progress</h5>
            </div>
            <div class="card-body">
              <div class="text-center mb-4">
                <div class="display-4 fw-bold text-primary">
                  <%= progressSummary.totalPoints %>
                </div>
                <div class="text-muted small text-uppercase tracking-wide">Total Points</div>
              </div>
              <div class="row text-center g-2 mb-3">
                <div class="col-6">
                  <div class="p-2 bg-light rounded">
                    <div class="h5 mb-0 text-success">
                      <%= progressSummary.teachPoints %>
                    </div>
                    <div class="small text-muted">Teaching</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="p-2 bg-light rounded">
                    <div class="h5 mb-0 text-info">
                      <%= progressSummary.learnPoints %>
                    </div>
                    <div class="small text-muted">Learning</div>
                  </div>
                </div>
              </div>
              <% if (Array.isArray(progressSummary.badges) && progressSummary.badges.length) { %>
                <div class="d-flex flex-wrap gap-1 justify-content-center">
                  <% progressSummary.badges.forEach(b=> { %>
                    <span class="badge <%= b.class %> rounded-pill">
                      <%= b.label %>
                    </span>
                    <% }) %>
                </div>
                <% } %>
            </div>
          </div>
          <% } %>

            <!-- Skills List -->
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="fas fa-tools me-2 text-primary"></i>Skills</h5>
              </div>
              <div class="card-body p-0">
                <% if (userSkills.length===0) { %>
                  <div class="p-3 text-center text-muted">No skills added yet.</div>
                  <% } else { %>
                    <div class="list-group list-group-flush">
                      <% userSkills.forEach(s=> { %>
                        <div class="list-group-item px-3 py-3">
                          <div class="d-flex justify-content-between align-items-start">
                            <div>
                              <div class="fw-bold mb-1">
                                <%= s.Skill?.name || '-' %>
                              </div>
                              <div class="small text-muted mb-2">
                                <%= s.Skill?.Category?.name || '' %>
                              </div>
                              <div>
                                <span class="badge <%= s.type === 'teach' ? 'bg-primary' : 'bg-info' %> me-1">
                                  <%= s.type %>
                                </span>
                                <span class="badge bg-light text-dark border">
                                  <%= s.level || '-' %>
                                </span>
                              </div>
                            </div>
                            <button class="btn btn-outline-danger btn-sm js-delete-skill rounded-circle"
                              data-id="<%= s.id %>" title="Delete Skill">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                          </div>
                        </div>
                        <% }) %>
                    </div>
                    <% } %>
              </div>
            </div>

            <!-- Availability List -->
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0"><i class="far fa-clock me-2 text-primary"></i>Availability</h5>
              </div>
              <div class="card-body p-0">
                <% if (avails.length===0) { %>
                  <div class="p-3 text-center text-muted">No availability set.</div>
                  <% } else { %>
                    <ul class="list-group list-group-flush">
                      <% avails.forEach(a=> { %>
                        <li class="list-group-item px-3 py-3 d-flex justify-content-between align-items-center">
                          <div class="d-flex align-items-center">
                            <div class="bg-light rounded p-2 me-3 text-center" style="min-width: 50px;">
                              <div class="fw-bold text-primary">
                                <%= DAYS[a.dayOfWeek ?? a.day_of_week ?? 0].substring(0, 3) %>
                              </div>
                            </div>
                            <div>
                              <div>
                                <%= (a.startTime || a.start_time || '' ).toString().slice(0,5) %> - <%= (a.endTime ||
                                    a.end_time || '' ).toString().slice(0,5) %>
                              </div>
                            </div>
                          </div>
                          <button class="btn btn-outline-danger btn-sm js-delete-availability rounded-circle"
                            data-id="<%= a.id %>" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </li>
                        <% }) %>
                    </ul>
                    <% } %>
              </div>
            </div>
      </div>

      <!-- Right Column: Edit & Actions -->
      <div class="col-12 col-lg-8">
        <!-- Edit Profile Form -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-0 py-3">
            <h5 class="card-title mb-0"><i class="fas fa-user-edit me-2 text-primary"></i>Edit Profile</h5>
          </div>
          <div class="card-body">
            <form method="POST" action="/profile/update?_csrf=<%= csrfToken %>" enctype="multipart/form-data">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Display Name</label>
                  <input class="form-control" name="name" required maxlength="100" value="<%= u.name || '' %>">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Profile Picture</label>
                  <input class="form-control" type="file" name="profileImage" accept="image/*">
                  <div class="form-text">Recommended: Square image, max 5MB.</div>
                </div>

                <div class="col-12">
                  <label class="form-label">Bio</label>
                  <textarea class="form-control" name="bio" rows="3" maxlength="1000"
                    placeholder="Tell others about yourself..."><%= u.bio || '' %></textarea>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Location</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                    <input class="form-control" name="location" maxlength="255" value="<%= u.location || '' %>"
                      placeholder="City, Country">
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">WhatsApp (E.164)</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fab fa-whatsapp"></i></span>
                    <input class="form-control" name="whatsappNumber" placeholder="+60123456789"
                      value="<%= u.whatsappNumber || '' %>">
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Profile Visibility</label>
                  <select class="form-select" name="isPublic">
                    <option value="true" <%=u.isPublic ? 'selected' : '' %>>Public (Visible to everyone)</option>
                    <option value="false" <%=!u.isPublic ? 'selected' : '' %>>Private (Hidden from search)</option>
                  </select>
                </div>
              </div>

              <div class="mt-4 text-end">
                <button class="btn btn-primary px-4">Save Changes</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Add Skill & Availability Forms -->
        <div class="row g-4 mb-4">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0"><i class="fas fa-plus-circle me-2 text-primary"></i>Add Skill</h5>
              </div>
              <div class="card-body">
                <form method="POST" action="/profile/skills">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                  <div class="mb-3">
                    <label class="form-label">Skill</label>
                    <select class="form-select" name="skillId" required>
                      <option value="">Select a skill...</option>
                      <% (skills || []).forEach(s=> { %>
                        <option value="<%= s.id %>">
                          <%= s.name %>
                            <%= s.Category ? '(' +s.Category.name+')' : '' %>
                        </option>
                        <% }) %>
                    </select>
                  </div>

                  <div class="row g-2 mb-3">
                    <div class="col-6">
                      <label class="form-label">Type</label>
                      <select class="form-select" name="type" required>
                        <option value="teach">Teach</option>
                        <option value="learn">Learn</option>
                      </select>
                    </div>
                    <div class="col-6">
                      <label class="form-label">Level</label>
                      <select class="form-select" name="level" required>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                      </select>
                    </div>
                  </div>

                  <button class="btn btn-outline-primary w-100">Add Skill</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0"><i class="fas fa-plus-circle me-2 text-primary"></i>Add Availability</h5>
              </div>
              <div class="card-body">
                <form method="POST" action="/profile/availability">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                  <div class="mb-3">
                    <label class="form-label">Day of Week</label>
                    <select class="form-select" name="dayOfWeek" required>
                      <% DAYS.forEach((d, idx)=> { %>
                        <option value="<%= idx %>">
                          <%= d %>
                        </option>
                        <% }) %>
                    </select>
                  </div>

                  <div class="row g-2 mb-3">
                    <div class="col-6">
                      <label class="form-label">Start Time</label>
                      <input type="time" class="form-control" name="startTime" required>
                    </div>
                    <div class="col-6">
                      <label class="form-label">End Time</label>
                      <input type="time" class="form-control" name="endTime" required>
                    </div>
                  </div>

                  <button class="btn btn-outline-primary w-100">Add Slot</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Notification Center -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0"><i class="fas fa-bell me-2 text-primary"></i>Notifications</h5>
            <span class="badge bg-danger rounded-pill" id="notificationCount"></span>
          </div>
          <div class="card-body p-0">
            <div id="userNotificationList" class="list-group list-group-flush">
              <div class="text-center text-muted p-4">
                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                <p class="mb-0">Loading notifications...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">Quick Actions</h5>
            <div class="d-flex flex-wrap gap-2">
              <a class="btn btn-primary" href="/listings/create">
                <i class="fas fa-plus me-1"></i> Create Listing
              </a>
              <a class="btn btn-outline-secondary" href="/sessions">
                <i class="fas fa-calendar-alt me-1"></i> My Sessions
              </a>
              <a class="btn btn-outline-secondary" href="/history/messages">
                <i class="fas fa-comments me-1"></i> Message History
              </a>
              <form method="post" action="/history/wa/mark/<%= u.id %>" class="d-inline">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button class="btn btn-outline-secondary">Mark Contacted</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Simple JS for DELETE actions with CSRF
    const csrfToken = '<%= csrfToken %>';

    document.addEventListener('click', async (e) => {
      const btnSkill = e.target.closest('.js-delete-skill');
      if (btnSkill) {
        const id = btnSkill.dataset.id;
        if (!confirm('Delete this skill?')) return;
        try {
          const res = await fetch('/profile/skills/' + id, {
            method: 'DELETE',
            headers: { 'CSRF-Token': csrfToken }
          });
          if (!res.ok) throw new Error('Failed');
          location.reload();
        } catch (err) {
          alert('Error deleting skill.');
        }
      }

      const btnAvail = e.target.closest('.js-delete-availability');
      if (btnAvail) {
        const id = btnAvail.dataset.id;
        if (!confirm('Delete this availability?')) return;
        try {
          const res = await fetch('/profile/availability/' + id, {
            method: 'DELETE',
            headers: { 'CSRF-Token': csrfToken }
          });
          if (!res.ok) throw new Error('Failed');
          location.reload();
        } catch (err) {
          alert('Error deleting availability.');
        }
      }
    });

    async function loadUserNotifications() {
      try {
        const response = await fetch('/listings/api/notifications', {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        });
        const data = await response.json();

        const list = document.getElementById('userNotificationList');
        const countBadge = document.getElementById('notificationCount');
        list.innerHTML = '';

        if (data.notifications && data.notifications.length > 0) {
          const unreadCount = data.notifications.filter(n => n.status === 'unread').length;
          if (unreadCount > 0) {
            countBadge.textContent = unreadCount;
            countBadge.classList.remove('d-none');
          } else {
            countBadge.classList.add('d-none');
          }

          data.notifications.forEach(notification => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = `list-group-item list-group-item-action px-4 py-3 ${notification.status === 'unread' ? 'bg-light fw-bold' : ''}`;
            item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="text-primary small text-uppercase">${notification.title}</span>
              <small class="text-muted">${new Date(notification.created_at).toLocaleDateString()}</small>
            </div>
            <p class="mb-0 text-dark">${notification.message}</p>
          `;
            item.addEventListener('click', async (e) => {
              e.preventDefault();
              await markUserNotificationAsRead(notification.id);
              item.classList.remove('bg-light', 'fw-bold');
              // Optionally decrement badge
            });
            list.appendChild(item);
          });
        } else {
          list.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-inbox fa-2x mb-2"></i><p class="mb-0">No notifications found.</p></div>';
          countBadge.classList.add('d-none');
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    }

    async function markUserNotificationAsRead(id) {
      try {
        await fetch(`/listings/api/notifications/${id}/read`, {
          method: 'POST',
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        });
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', loadUserNotifications);

    // Profile Image Validation
    const profileImageInput = document.querySelector('input[name="profileImage"]');
    if (profileImageInput) {
      profileImageInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
          // Check file size (5MB = 5 * 1024 * 1024 bytes)
          const maxSize = 5 * 1024 * 1024;
          if (file.size > maxSize) {
            Swal.fire({
              icon: 'error',
              title: 'File Too Large',
              text: 'The image size should not exceed 5MB.',
            });
            this.value = ''; // Clear the input
            return;
          }

          // Check file type
          const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
          if (!validTypes.includes(file.type)) {
            Swal.fire({
              icon: 'error',
              title: 'Invalid File Type',
              text: 'Please upload a valid image (JPEG, PNG, GIF, WEBP).',
            });
            this.value = ''; // Clear the input
            return;
          }
        }
      });
    }
  </script>