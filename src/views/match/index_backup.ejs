<% const hasMatches=Array.isArray(matches) && matches.length> 0;
  const topMatch = hasMatches ? matches[0] : null;
  %>

  <div class="card bg-primary text-white border-0 rounded-4 shadow-sm mb-4">
    <div class="card-body p-4 p-md-5">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
          <p class="text-white-50 text-uppercase small mb-1">SkillSwap assistant</p>
          <h1 class="h3 mb-2">Find Your Ideal SkillSwap Partner</h1>
          <p class="mb-0 text-white-50">Matches consider what you can teach, what you want to learn, and when you are
            both available.</p>
        </div>
        <% if (topMatch) { %>
          <div class="bg-white text-primary rounded-4 px-4 py-3 text-md-end shadow-sm">
            <div class="text-uppercase small fw-semibold">Top match score</div>
            <div class="display-6 fw-bold mb-0">
              <%= topMatch.score.toFixed(1) %>
            </div>
            <div class="small text-muted">with <strong>
                <%= topMatch.user.name %>
              </strong></div>
          </div>
          <% } %>
      </div>
    </div>
  </div>

  <% if (hasMatches) { %>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% matches.forEach(match=> {
        // Get unique days for availability (simplified)
        const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        let availDays = [];
        if (Array.isArray(match.user.availabilities) && match.user.availabilities.length) {
        const daySet = new Set();
        match.user.availabilities.forEach(a => {
        const dayIdx = (typeof a.dayOfWeek === 'number') ? a.dayOfWeek : a.day_of_week;
        if (typeof dayIdx === 'number') daySet.add(days[dayIdx % 7]);
        });
        availDays = Array.from(daySet).slice(0, 5);
        }

        // Convert score to percentage
        const matchPercent = Math.min(Math.round(match.score * 100), 99);

        // Get matched skill names
        const teachSkillNames = (match.teachSkills || []).slice(0, 3).map(s => s.name);
        const learnSkillNames = (match.learnSkills || []).slice(0, 3).map(s => s.name);

        // Natural language match description
        let matchDescription = '';
        if (teachSkillNames.length > 0) {
        matchDescription = 'Can teach you: ' + teachSkillNames.join(', ');
        }

        // Truncate bio
        const bioText = match.user.bio ? (match.user.bio.length > 100 ? match.user.bio.substring(0, 100) + '...' :
        match.user.bio) : '';

        // WhatsApp number
        const waNumber = match.user.whatsappNumber || match.user.whatsapp_number;
        %>
        <div class="col">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body p-4">
              <!-- Header: Avatar + Name + Location | Match % Badge -->
              <div class="d-flex align-items-start gap-3 mb-3">
                <% if (match.user.profileImage || match.user.profile_image) { %>
                  <img src="<%= match.user.profileImage || match.user.profile_image %>" alt="<%= match.user.name %>"
                    class="rounded-circle flex-shrink-0"
                    style="width: 56px; height: 56px; object-fit: cover; border: 2px solid #e9ecef;">
                  <% } else { %>
                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center flex-shrink-0"
                      style="width: 56px; height: 56px; border: 2px solid #e9ecef;">
                      <i class="fas fa-user fa-lg text-muted"></i>
                    </div>
                    <% } %>
                      <div class="flex-grow-1 min-width-0">
                        <div class="d-flex align-items-center justify-content-between gap-2">
                          <h5 class="card-title mb-0 fw-bold text-truncate">
                            <%= match.user.name %>
                          </h5>
                          <span
                            class="badge rounded-pill flex-shrink-0 <%= matchPercent >= 70 ? 'bg-success' : (matchPercent >= 40 ? 'bg-primary' : 'bg-secondary') %>"
                            style="font-size: 0.8rem; padding: 0.4em 0.8em;">
                            <%= matchPercent %>% Match
                          </span>
                        </div>
                        <% if (match.user.location) { %>
                          <span class="text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <%= match.user.location %>
                          </span>
                          <% } %>
                      </div>
              </div>

              <!-- Natural Language Match Description -->
              <% if (matchDescription) { %>
                <p class="mb-3 text-success fw-medium" style="font-size: 0.9rem;">
                  <i class="fas fa-check-circle me-1"></i>
                  <%= matchDescription %>
                </p>
                <% } %>

                  <!-- Bio (if no match description) -->
                  <% if (bioText && !matchDescription) { %>
                    <p class="text-secondary mb-3" style="font-size: 0.875rem; line-height: 1.5;">
                      <%= bioText %>
                    </p>
                    <% } %>

                      <!-- Skills: Teach & Learn -->
                      <div class="mb-3">
                        <% if (teachSkillNames.length> 0) { %>
                          <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                            <span class="text-success" style="font-size: 0.85rem;" title="Can teach"><i
                                class="fas fa-graduation-cap"></i></span>
                            <% teachSkillNames.forEach(name=> { %>
                              <span class="badge bg-success-subtle text-success border-0" style="font-weight: 500;">
                                <%= name %>
                              </span>
                              <% }) %>
                                <% if ((match.teachSkills || []).length> 3) { %>
                                  <span class="text-muted small">+<%= match.teachSkills.length - 3 %></span>
                                  <% } %>
                          </div>
                          <% } %>
                            <% if (learnSkillNames.length> 0) { %>
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="text-primary" style="font-size: 0.85rem;" title="Wants to learn"><i
                                    class="fas fa-seedling"></i></span>
                                <% learnSkillNames.forEach(name=> { %>
                                  <span class="badge bg-primary-subtle text-primary border-0" style="font-weight: 500;">
                                    <%= name %>
                                  </span>
                                  <% }) %>
                                    <% if ((match.learnSkills || []).length> 3) { %>
                                      <span class="text-muted small">+<%= match.learnSkills.length - 3 %></span>
                                      <% } %>
                              </div>
                              <% } %>
                      </div>

                      <!-- Availability: Simple day list -->
                      <% if (availDays.length> 0) { %>
                        <div class="d-flex align-items-center gap-2 text-muted small">
                          <i class="far fa-calendar-check"></i>
                          <span>
                            <%= availDays.join(', ') %></span>
              <% if (match.user.availabilities && match.user.availabilities.length > 5) { %>
                <span class="text-muted">+more</span>
              <% } %>
            </div>
          <% } %>
        </div>

        <!-- Footer Actions -->
        <div class="card-footer bg-white border-top px-4 py-3">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-primary btn-sm flex-grow-1 js-quick-request"
              data-user="<%= match.user.id %>"
              data-skill="<%= match.teachSkills && match.teachSkills[0] ? match.teachSkills[0].id : '' %>"
              data-name="<%= match.user.name %>">
              <i class="fas fa-bolt me-1"></i> Quick Request
            </button>
            <a class="btn btn-outline-secondary btn-sm" href="/browse/user/<%= match.user.id %>?from=match" title="View Profile">
              <i class="fas fa-user"></i>
            </a>
            <% if (waNumber) { %>
              <a class="btn btn-outline-success btn-sm" target="_blank" rel="noopener" title="WhatsApp"
                href="/go/wa/<%= match.user.id %>?text=<%- encodeURIComponent(' Hi ' + match.user.name + ' , I found
                              you on SkillSwap MY!') %>">
                              <i class="fab fa-whatsapp"></i>
                              </a>
                              <% } %>
                                <button class="btn btn-outline-danger btn-sm js-tip" data-user-id="<%= match.user.id %>"
                                  data-user-name="<%= match.user.name %>" title="Send Tip">
                                  <i class="far fa-heart"></i>
                                </button>
                        </div>
            </div>
          </div>
        </div>
        <% }); %>
    </div>
    <% } else { %>
      <div class="alert alert-warning text-center" role="alert">
        <i class="fas fa-circle-info me-2"></i>No matches found yet. Try adding more skills or updating your
        availability.
      </div>
      <% } %>

        <!-- Quick Request Script -->
        <script>
          document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.js-quick-request').forEach(btn => {
              btn.addEventListener('click', async function () {
                const teacherId = this.dataset.user;
                const skillId = this.dataset.skill;
                const teacherName = this.dataset.name;

                if (!skillId) {
                  Swal.fire({
                    icon: 'warning',
                    title: 'No Skills Available',
                    text: `${teacherName} has no teaching skills listed. Please contact them directly.`,
                    position: 'center',
                    customClass: { container: 'swal2-centered-container' }
                  });
                  return;
                }

                // Show loading
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Checking...';

                try {
                  const response = await fetch('/sessions/quick-request', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-CSRF-Token': '<%= csrfToken %>'
                    },
                    body: JSON.stringify({ teacherId, skillId })
                  });

                  const data = await response.json();

                  if (data.success) {
                    Swal.fire({
                      icon: 'success',
                      title: 'Session Requested!',
                      text: data.message,
                      confirmButtonText: 'View My Sessions',
                      position: 'center',
                      customClass: { container: 'swal2-centered-container' }
                    }).then(() => {
                      window.location.href = '/sessions';
                    });
                  } else if (data.noMatch) {
                    Swal.fire({
                      icon: 'info',
                      title: 'No Matching Time',
                      html: `<p>${data.message}</p><p class="text-muted small mt-2">${data.contact}</p>`,
                      confirmButtonText: 'Got it',
                      position: 'center',
                      customClass: { container: 'swal2-centered-container' }
                    });
                  } else {
                    Swal.fire({
                      icon: 'error',
                      title: 'Unable to Request',
                      text: data.message,
                      position: 'center',
                      customClass: { container: 'swal2-centered-container' }
                    });
                  }
                } catch (error) {
                  Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong. Please try again.',
                    position: 'center',
                    customClass: { container: 'swal2-centered-container' }
                  });
                }

                // Reset button
                this.disabled = false;
                this.innerHTML = originalText;
              });
            });
          });
        </script>
