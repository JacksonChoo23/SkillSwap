<div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Checkout</h1>
    <a class="btn btn-outline-secondary" href="javascript:history.back()">Back</a>
</div>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form id="payment-form">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                    <div class="mb-4">
                        <label for="amount" class="form-label fw-bold">Amount (MYR)</label>
                        <div class="input-group">
                            <span class="input-group-text">RM</span>
                            <input type="number" class="form-control form-control-lg" id="amount" name="amount"
                                value="<%= amount %>" min="1" step="0.01" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="description" class="form-label fw-bold">Description</label>
                        <input type="text" class="form-control" id="description" name="description"
                            value="<%= description %>" maxlength="200" placeholder="e.g. Session on 25th">
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3">Payment Details</h5>

                    <!-- Stripe Elements will be mounted here -->
                    <div id="payment-element" class="mb-3">
                        <!-- Stripe Payment Element -->
                    </div>

                    <!-- Checkbox to save card -->
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="save-card">
                        <label class="form-check-label" for="save-card">
                            Save card for future payments
                        </label>
                    </div>

                    <div id="error-message" class="alert alert-danger d-none small mb-3"></div>

                    <button type="submit" class="btn btn-primary w-100 btn-lg" id="submit-btn" disabled>
                        <span id="button-text">Pay Now</span>
                        <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                    </button>

                    <div class="text-center mt-3 text-muted small">
                        <i class="bi bi-lock-fill"></i> Secure payment powered by Stripe
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const stripe = Stripe('<%= stripePublishableKey %>');
        const form = document.getElementById('payment-form');
        const submitBtn = document.getElementById('submit-btn');
        const amountInput = document.getElementById('amount');
        let elements;

        // Initialize Elements (we'll need a PaymentIntent first usually, OR use 'mode: payment' and amount in client)
        // However, standard flow involves creating PI on backend.
        // Since amount is editable, we should create PI when user clicks Pay OR update it dynamically.
        // For simplicity: We will create the PI when the user submits (Client-side Confirm logic with dynamic secret fetch)
        // BUT Stripe Payment Element requires a client secret to render OR 'mode' + 'amount' if using appearance API (but still need intent eventually).
        // Best approach for dynamic amount: 
        // 1. Fetch ClientSecret when page loads (if fixed amount) OR when amount changes (debounced).
        // 2. OR render Element in 'setup' mode? No, this is checkout.

        // Let's implement: Fetch PaymentIntent ON LOAD with initial amount.
        // If user changes amount, we Update the PaymentIntent (need new endpoint) or Create New.
        // Simpler: Validate amount on submit, create PI via AJAX, THEN confirm.
        // Wait, Payment Element needs to be mounted with client secret.

        // Strategy: 
        // 1. Load page. 
        // 2. JS calls /payment/create-payment-intent with current amount.
        // 3. Mount element.
        // 4. On Amount change -> Update parameters (re-fetch/update).

        async function initialize() {
            const amountVal = amountInput.value;
            if (!amountVal || amountVal < 1) return;

            submitBtn.disabled = true;

            const response = await fetch('/payment/create-payment-intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'CSRF-Token': form.querySelector('[name="_csrf"]').value
                },
                body: JSON.stringify({
                    amount: amountVal,
                    description: document.getElementById('description').value
                })
            });

            const { clientSecret } = await response.json();

            const appearance = { theme: 'stripe' };
            elements = stripe.elements({ appearance, clientSecret });

            const paymentElement = elements.create('payment', { layout: 'tabs' });
            paymentElement.mount('#payment-element');

            paymentElement.on('ready', () => {
                submitBtn.disabled = false;
            });
        }

        // Initialize if amount is present
        if (amountInput.value) {
            initialize();
        }

        // Handle amount change (debounced for production, here simple blur)
        amountInput.addEventListener('change', async () => {
            // Re-initialize or update amount... complex with Elements.
            // For simplify, we reload page or warn user?
            // Or verify logic: Destroy old element and re-init.
            if (elements) {
                const cardEl = document.getElementById('payment-element');
                cardEl.innerHTML = ''; // clear
                await initialize();
            } else {
                await initialize();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!elements) return;

            setLoading(true);

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    // Make sure to include return_url!
                    return_url: window.location.origin + '/payment/success', // We need this route!
                    // Or reuse history page
                    return_url: window.location.origin + '/payment',
                },
            });

            if (error) {
                showMessage(error.message);
                setLoading(false);
            } else {
                // Your customer will be redirected to your `return_url`.
            }
        });

        function showMessage(messageText) {
            const messageContainer = document.querySelector("#error-message");
            messageContainer.classList.remove("d-none");
            messageContainer.textContent = messageText;
            setTimeout(() => {
                messageContainer.classList.add("d-none");
                messageContainer.textContent = "";
            }, 4000);
        }

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                document.querySelector("#spinner").classList.remove("d-none");
                document.querySelector("#button-text").classList.add("d-none");
            } else {
                submitBtn.disabled = false;
                document.querySelector("#spinner").classList.add("d-none");
                document.querySelector("#button-text").classList.remove("d-none");
            }
        }
    });
</script>