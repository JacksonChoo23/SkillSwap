<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %> - SkillSwap MY
    </title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/loader.css">
    <link rel="stylesheet" href="/css/star-rating.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Global SweetAlert2 defaults for consistent centering
        const SwalCentered = Swal.mixin({
            position: 'center',
            backdrop: true,
            allowOutsideClick: true,
            customClass: {
                container: 'swal2-centered-container'
            }
        });
    </script>

    <!-- Loader Script (Inline for immediate execution) -->
    <script src="/js/loader.js"></script>
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- Page Loader -->
    <div id="page-loader" class="page-loader">
        <div class="loader-content">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loader-text">Loading SkillSwap MY...</div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-content">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <img src="/logo.png" alt="SkillSwap" style="height: 32px; width: auto;" class="me-2">
                    SkillSwap MY
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link <%= title === 'My Dashboard - SkillSwap MY' ? 'active' : '' %>"
                                href="/">Home</a>
                        </li>
                        <% if (isAuthenticated) { %>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="browseDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Browse
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="browseDropdown">
                                    <li><a class="dropdown-item" href="/listings">Browse Listings</a></li>
                                    <li><a class="dropdown-item" href="/browse">Browse Users</a></li>
                                </ul>
                            </li>
                            <% } %>
                                <li class="nav-item">
                                    <a class="nav-link" href="/about">About</a>
                                </li>
                                <li class="nav-item">
                                    <% if (isAuthenticated) { %>
                                        <a class="nav-link" href="/calculator">Calculator</a>
                                        <% } %>
                                </li>
                                <% if (isAuthenticated) { %>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/match">Find Matches</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/messages">Messages</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/sessions">My Sessions</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/leaderboard">Leaderboard</a>
                                    </li>
                                    <% if (isAdmin) { %>
                                        <li class="nav-item">
                                            <a class="nav-link" href="/admin">Admin</a>
                                        </li>
                                        <% } %>
                                            <% } %>
                    </ul>

                    <ul class="navbar-nav">
                        <% if (isAuthenticated) { %>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                                    data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-1"></i>
                                    <%= user.name %>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/profile">My Profile</a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item" href="/auth/logout">Logout</a></li>
                                </ul>
                            </li>
                            <% } else { %>
                                <li class="nav-item">
                                    <a class="nav-link" href="/auth/login">Login</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/auth/register">Register</a>
                                </li>
                                <% } %>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Flash Messages -->
        <% (Array.isArray(success) ? success : []).forEach(function(msg){ %>
            <script>Swal.fire({ icon: 'success', title: 'Success', text: '<%= msg %>', showConfirmButton: true, position: 'center', timer: null, timerProgressBar: false, allowOutsideClick: false });</script>
            <% }); %>

                <% (Array.isArray(error) ? error : []).forEach(function(msg){ %>
                    <script>Swal.fire({ icon: 'error', title: 'Error', text: '<%= msg %>', showConfirmButton: true, position: 'center', timer: null, timerProgressBar: false, allowOutsideClick: false });</script>
                    <% }); %>

                        <% (Array.isArray(info) ? info : []).forEach(function(msg){ %>
                            <script>Swal.fire({ icon: 'info', title: 'Info', text: '<%= msg %>', showConfirmButton: true, position: 'center', timer: null, timerProgressBar: false, allowOutsideClick: false });</script>
                            <% }); %>

                                <!-- Main Content -->
                                <main class="container my-4 flex-grow-1 w-100">
                                    <%- body %>
                                        <% if (isAuthenticated) { %>
                                            <%- include('../partials/tip_modal') %>
                                                <%- include('../partials/report_modal') %>
                                                    <%- include('../partials/request_session_modal') %>
                                                        <% } %>
                                </main>

                                <!-- Footer -->
                                <footer class="bg-light py-4 border-top mt-auto w-100">
                                    <div class="container">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h5>SkillSwap MY</h5>
                                                <p class="text-muted">Connecting Malaysians through skill exchange</p>
                                            </div>
                                            <div class="col-md-6 text-md-end">
                                                <p class="text-muted">&copy; 2024 SkillSwap MY. All rights reserved.</p>
                                                <a href="/about" class="text-decoration-none">About</a>
                                            </div>
                                        </div>
                                    </div>
                                </footer>
    </div>
    <!-- End Main Content Wrapper -->

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Animations JS -->
    <script src="/js/animations.js"></script>

    <!-- Custom JS -->
    <script src="/js/app.js"></script>

    <!-- Real-time Account Status via WebSocket (only for authenticated users) -->
    <% if (isAuthenticated && currentUser) { %>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            (function () {
                // Connect to Socket.io
                const socket = io();
                const userId = '<%= currentUser.id %>';

                // Join user-specific room for global updates
                socket.on('connect', () => {
                    socket.emit('join_user', userId);
                });

                // Listen for force_logout event (suspension/ban)
                socket.on('force_logout', (data) => {
                    let countdown = 10;
                    const countdownHtml = data.type === 'suspended'
                        ? `<p>${data.message}</p><p class="text-muted mt-2"><strong>Reason:</strong> ${data.reason}</p><p class="mt-3"><strong>Logging out in <span id="countdown">${countdown}</span> seconds...</strong></p>`
                        : `<p>${data.message}</p><p class="mt-3"><strong>Logging out in <span id="countdown">${countdown}</span> seconds...</strong></p>`;

                    Swal.fire({
                        icon: data.type === 'banned' ? 'error' : 'warning',
                        title: data.title,
                        html: countdownHtml,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            const countdownEl = document.getElementById('countdown');
                            const countdownInterval = setInterval(() => {
                                countdown--;
                                if (countdownEl) countdownEl.textContent = countdown;
                                if (countdown <= 0) {
                                    clearInterval(countdownInterval);
                                    window.location.href = '/auth/logout';
                                }
                            }, 1000);
                        }
                    });
                });
            })();
        </script>
        <% } %>
</body>

</html>