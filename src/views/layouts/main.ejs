<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %> - SkillSwap MY
    </title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/loader.css">
    <link rel="stylesheet" href="/css/star-rating.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Global SweetAlert2 defaults for consistent centering
        const SwalCentered = Swal.mixin({
            position: 'center',
            backdrop: true,
            allowOutsideClick: true,
            customClass: {
                container: 'swal2-centered-container'
            }
        });
    </script>

    <!-- Loader Script (Inline for immediate execution) -->
    <script src="/js/loader.js"></script>
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- Page Loader -->
    <div id="page-loader" class="page-loader">
        <div class="loader-content">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loader-text">Loading SkillSwap MY...</div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-content">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <img src="/logo.png" alt="SkillSwap" style="height: 32px; width: auto;" class="me-2">
                    SkillSwap MY
                </a>

                <!-- Mobile Toggle Button - triggers offcanvas -->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#mobileNav" aria-controls="mobileNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Desktop Navigation (hidden on mobile) -->
                <div class="collapse navbar-collapse d-none d-lg-flex" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link <%= title === 'My Dashboard - SkillSwap MY' ? 'active' : '' %>"
                                href="/">Home</a>
                        </li>
                        <% if (isAuthenticated) { %>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="browseDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Browse
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="browseDropdown">
                                    <li><a class="dropdown-item" href="/listings">Browse Listings</a></li>
                                    <li><a class="dropdown-item" href="/browse">Browse Users</a></li>
                                </ul>
                            </li>
                            <% } %>
                                <li class="nav-item">
                                    <a class="nav-link" href="/about">About</a>
                                </li>
                                <li class="nav-item">
                                    <% if (isAuthenticated) { %>
                                        <a class="nav-link" href="/calculator">Calculator</a>
                                        <% } %>
                                </li>
                                <% if (isAuthenticated) { %>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/match">Find Matches</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/messages">Messages</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/sessions">My Sessions</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/leaderboard">Leaderboard</a>
                                    </li>
                                    <% if (isAdmin) { %>
                                        <li class="nav-item">
                                            <a class="nav-link" href="/admin">Admin</a>
                                        </li>
                                        <% } %>
                                            <% } %>
                    </ul>

                    <ul class="navbar-nav">
                        <% if (isAuthenticated) { %>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                                    data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-1"></i>
                                    <%= user.name %>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="/profile">My Profile</a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item" href="/auth/logout">Logout</a></li>
                                </ul>
                            </li>
                            <% } else { %>
                                <li class="nav-item">
                                    <a class="nav-link" href="/auth/login">Login</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/auth/register">Register</a>
                                </li>
                                <% } %>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Mobile Offcanvas Side Navigation -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
            <div class="offcanvas-header bg-primary text-white">
                <h5 class="offcanvas-title" id="mobileNavLabel">
                    <i class="fas fa-bars me-2"></i>Menu
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                    aria-label="Close"></button>
            </div>
            <div class="offcanvas-body p-0">
                <!-- User Info (if authenticated) -->
                <% if (isAuthenticated) { %>
                    <div class="bg-light p-3 border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                                style="width: 48px; height: 48px; font-size: 1.25rem;">
                                <%= user.name.charAt(0).toUpperCase() %>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-semibold">
                                    <%= user.name %>
                                </h6>
                                <small class="text-muted">
                                    <%= user.email %>
                                </small>
                            </div>
                        </div>
                    </div>
                    <% } %>

                        <!-- Navigation Links -->
                        <div class="list-group list-group-flush">
                            <a href="/" class="list-group-item list-group-item-action py-3" data-bs-dismiss="offcanvas">
                                <i class="fas fa-home me-3 text-primary"></i>Home
                            </a>
                            <a href="/about" class="list-group-item list-group-item-action py-3"
                                data-bs-dismiss="offcanvas">
                                <i class="fas fa-info-circle me-3 text-primary"></i>About
                            </a>

                            <% if (isAuthenticated) { %>
                                <div class="list-group-item py-2 bg-light">
                                    <small class="text-uppercase text-muted fw-semibold">Browse</small>
                                </div>
                                <a href="/listings" class="list-group-item list-group-item-action py-3 ps-4"
                                    data-bs-dismiss="offcanvas">
                                    <i class="fas fa-list me-3 text-primary"></i>Browse Listings
                                </a>
                                <a href="/browse" class="list-group-item list-group-item-action py-3 ps-4"
                                    data-bs-dismiss="offcanvas">
                                    <i class="fas fa-users me-3 text-primary"></i>Browse Users
                                </a>

                                <div class="list-group-item py-2 bg-light">
                                    <small class="text-uppercase text-muted fw-semibold">Features</small>
                                </div>
                                <a href="/match" class="list-group-item list-group-item-action py-3 ps-4"
                                    data-bs-dismiss="offcanvas">
                                    <i class="fas fa-handshake me-3 text-primary"></i>Find Matches
                                </a>
                                <a href="/messages" class="list-group-item list-group-item-action py-3 ps-4"
                                    data-bs-dismiss="offcanvas">
                                    <i class="fas fa-comments me-3 text-primary"></i>Messages
                                </a>
                                <a href="/sessions" class="list-group-item list-group-item-action py-3 ps-4"
                                    data-bs-dismiss="offcanvas">
                                    <i class="fas fa-calendar me-3 text-primary"></i>My Sessions
                                </a>
                                <a href="/leaderboard" class="list-group-item list-group-item-action py-3 ps-4"
                                    data-bs-dismiss="offcanvas">
                                    <i class="fas fa-trophy me-3 text-primary"></i>Leaderboard
                                </a>
                                <a href="/calculator" class="list-group-item list-group-item-action py-3 ps-4"
                                    data-bs-dismiss="offcanvas">
                                    <i class="fas fa-calculator me-3 text-primary"></i>Calculator
                                </a>

                                <% if (isAdmin) { %>
                                    <div class="list-group-item py-2 bg-light">
                                        <small class="text-uppercase text-muted fw-semibold">Admin</small>
                                    </div>
                                    <a href="/admin" class="list-group-item list-group-item-action py-3 ps-4"
                                        data-bs-dismiss="offcanvas">
                                        <i class="fas fa-cog me-3 text-danger"></i>Admin Panel
                                    </a>
                                    <% } %>

                                        <div class="list-group-item py-2 bg-light">
                                            <small class="text-uppercase text-muted fw-semibold">Account</small>
                                        </div>
                                        <a href="/profile" class="list-group-item list-group-item-action py-3 ps-4"
                                            data-bs-dismiss="offcanvas">
                                            <i class="fas fa-user me-3 text-primary"></i>My Profile
                                        </a>
                                        <a href="/auth/logout"
                                            class="list-group-item list-group-item-action py-3 ps-4 text-danger"
                                            data-bs-dismiss="offcanvas">
                                            <i class="fas fa-sign-out-alt me-3"></i>Logout
                                        </a>
                                        <% } else { %>
                                            <div class="list-group-item py-2 bg-light">
                                                <small class="text-uppercase text-muted fw-semibold">Account</small>
                                            </div>
                                            <a href="/auth/login"
                                                class="list-group-item list-group-item-action py-3 ps-4"
                                                data-bs-dismiss="offcanvas">
                                                <i class="fas fa-sign-in-alt me-3 text-primary"></i>Login
                                            </a>
                                            <a href="/auth/register"
                                                class="list-group-item list-group-item-action py-3 ps-4"
                                                data-bs-dismiss="offcanvas">
                                                <i class="fas fa-user-plus me-3 text-primary"></i>Register
                                            </a>
                                            <% } %>
                        </div>
            </div>
        </div>



        <!-- Main Content -->
        <main class="container my-4 flex-grow-1 w-100">
            <%- body %>
                <% if (isAuthenticated) { %>
                    <%- include('../partials/tip_modal') %>
                        <%- include('../partials/report_modal') %>
                            <%- include('../partials/request_session_modal') %>
                                <% } %>
        </main>

        <!-- Footer -->
        <footer class="bg-light py-4 border-top mt-auto w-100">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <h5>SkillSwap MY</h5>
                        <p class="text-muted">Connecting Malaysians through skill exchange</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="text-muted">&copy; 2024 SkillSwap MY. All rights reserved.</p>
                        <a href="/about" class="text-decoration-none">About</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <!-- End Main Content Wrapper -->

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Animations JS -->
    <script src="/js/animations.js"></script>

    <!-- Custom JS -->
    <script src="/js/app.js"></script>

    <!-- Real-time Account Status via WebSocket (only for authenticated users) -->
    <% if (isAuthenticated && currentUser) { %>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            (function () {
                // Connect to Socket.io
                const socket = io();
                const userId = '<%= currentUser.id %>';

                // Join user-specific room for global updates
                socket.on('connect', () => {
                    socket.emit('join_user', userId);
                });

                // Listen for force_logout event (suspension/ban)
                socket.on('force_logout', (data) => {
                    let countdown = 10;
                    const countdownHtml = data.type === 'suspended'
                        ? `<p>${data.message}</p><p class="text-muted mt-2"><strong>Reason:</strong> ${data.reason}</p><p class="mt-3"><strong>Logging out in <span id="countdown">${countdown}</span> seconds...</strong></p>`
                        : `<p>${data.message}</p><p class="mt-3"><strong>Logging out in <span id="countdown">${countdown}</span> seconds...</strong></p>`;

                    Swal.fire({
                        icon: data.type === 'banned' ? 'error' : 'warning',
                        title: data.title,
                        html: countdownHtml,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            const countdownEl = document.getElementById('countdown');
                            const countdownInterval = setInterval(() => {
                                countdown--;
                                if (countdownEl) countdownEl.textContent = countdown;
                                if (countdown <= 0) {
                                    clearInterval(countdownInterval);
                                    window.location.href = '/auth/logout';
                                }
                            }, 1000);
                        }
                    });
                });
            })();
        </script>
        <% } %>

            <!-- Flash Messages - placed at end to ensure proper centering -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
        <% (Array.isArray(success) ? success : []).forEach(function (msg) { %>
                    Swal.fire({ icon: 'success', title: 'Success', text: '<%= msg %>', showConfirmButton: true, position: 'center', timer: null, timerProgressBar: false, allowOutsideClick: false });
        <% }); %>
        <% (Array.isArray(error) ? error : []).forEach(function (msg) { %>
                        Swal.fire({ icon: 'error', title: 'Error', text: '<%= msg %>', showConfirmButton: true, position: 'center', timer: null, timerProgressBar: false, allowOutsideClick: false });
        <% }); %>
        <% (Array.isArray(info) ? info : []).forEach(function (msg) { %>
                            Swal.fire({ icon: 'info', title: 'Info', text: '<%= msg %>', showConfirmButton: true, position: 'center', timer: null, timerProgressBar: false, allowOutsideClick: false });
        <% }); %>
    });
            </script>
</body>

</html>