<%
  const s = session || {};
  const fmt = value => value ? new Date(value).toLocaleString('en-MY', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
  const statusBadge = status => (
    status === 'requested'  ? 'bg-warning text-dark' :
    status === 'confirmed'  ? 'bg-primary' :
    status === 'in_progress'? 'bg-info text-dark' :
    status === 'completed'  ? 'bg-success' :
    status === 'cancelled'  ? 'bg-secondary' : 'bg-light text-dark'
  );
%>

<div class="card border-0 shadow-sm mb-4">
  <div class="card-body p-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
      <div>
        <a class="btn btn-link text-decoration-none p-0 mb-2" href="/sessions"><i class="fas fa-arrow-left me-1"></i>Back to Sessions</a>
        <h1 class="h4 mb-1"><%= s.Skill?.name || 'Skill Session' %></h1>
        <p class="text-muted mb-0">Track the session timeline, participants, and key actions from this dashboard.</p>
      </div>
      <div class="text-lg-end">
        <div class="text-muted text-uppercase small">Status</div>
        <span class="badge <%= statusBadge(s.status) %> fs-6"><%= s.status %></span>
        <div class="mt-2 small">Created on <%= fmt(s.createdAt) %></div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white border-0 pb-0">
        <h2 class="h6 text-uppercase text-muted mb-0">Session overview</h2>
      </div>
      <div class="card-body">
        <div class="row row-cols-1 row-cols-sm-2 g-3">
          <div>
            <p class="text-muted small mb-1">Teacher</p>
            <div class="fw-semibold"><%= s.teacher?.name || 'Pending' %></div>
          </div>
          <div>
            <p class="text-muted small mb-1">Learner</p>
            <div class="fw-semibold"><%= s.student?.name || 'Pending' %></div>
          </div>
          <div>
            <p class="text-muted small mb-1">Skill</p>
            <div class="fw-semibold"><%= s.Skill?.name || '-' %></div>
          </div>
          <div>
            <p class="text-muted small mb-1">Planned start</p>
            <div><%= fmt(s.startAt) %></div>
          </div>
          <div>
            <p class="text-muted small mb-1">Planned end</p>
            <div><%= fmt(s.endAt) %></div>
          </div>
          <% if (s.actualStartAt || s.actualEndAt) { %>
            <div>
              <p class="text-muted small mb-1">Actual start</p>
              <div><%= fmt(s.actualStartAt) %></div>
            </div>
            <div>
              <p class="text-muted small mb-1">Actual end</p>
              <div><%= fmt(s.actualEndAt) %></div>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white border-0 pb-0">
        <h2 class="h6 text-uppercase text-muted mb-0">Next actions</h2>
      </div>
      <div class="card-body">
        <div class="d-flex flex-wrap gap-3">
          <% if (s.status === 'requested' && user && s.teacherId === user.id) { %>
            <form method="POST" action="/sessions/<%= s.id %>/confirm" class="d-flex flex-column">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button class="btn btn-primary"><i class="fas fa-check me-1"></i>Confirm request</button>
              <small class="text-muted text-center mt-1">Only teachers can confirm</small>
            </form>
          <% } %>

          <% if (s.status === 'confirmed' && user && s.teacherId === user.id) { %>
            <div class="d-flex flex-column gap-2">
              <form method="POST" action="/sessions/<%= s.id %>/generate-code" class="d-flex flex-column">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button class="btn btn-outline-primary"><i class="fas fa-key me-1"></i>Generate start code</button>
                <small class="text-muted text-center mt-1">Share it with your learner</small>
              </form>
              <% if (s.startCode) { %>
                <div class="alert alert-light border mt-1 mb-0">
                  <div class="fw-semibold">Code: <%= s.startCode %></div>
                  <div class="small text-muted">Expires <%= fmt(s.codeExpiresAt) %></div>
                </div>
              <% } %>
            </div>
          <% } %>

          <% if (s.status === 'confirmed' && user && s.studentId === user.id) { %>
            <form method="POST" action="/sessions/<%= s.id %>/verify-code" class="flex-grow-1">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <label class="form-label small text-muted">Enter start code</label>
              <div class="input-group">
                <input name="code" class="form-control" placeholder="3-digit code" pattern="\d{3,6}" required>
                <button class="btn btn-success" type="submit">Start session</button>
              </div>
            </form>
          <% } %>

          <% if (s.status === 'in_progress' && user && s.teacherId === user.id) { %>
            <form method="POST" action="/sessions/<%= s.id %>/end" class="d-flex flex-column">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button class="btn btn-success"><i class="fas fa-flag-checkered me-1"></i>End session</button>
              <small class="text-muted text-center mt-1">Stops the timer and records progress</small>
            </form>
          <% } %>

          <% if (s.status !== 'completed' && user && (s.teacherId === user.id || s.studentId === user.id)) { %>
            <form method="POST" action="/sessions/<%= s.id %>/cancel" class="d-flex flex-column">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button class="btn btn-outline-danger"><i class="fas fa-ban me-1"></i>Cancel session</button>
              <small class="text-muted text-center mt-1">Available to both parties</small>
            </form>
          <% } %>
        </div>
      </div>
    </div>

    <% if (s.status === 'in_progress' && s.actualStartAt) { %>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body text-center">
          <p class="text-muted small text-uppercase mb-1">Live stopwatch</p>
          <div class="display-5 fw-bold" id="stopwatch">00:00:00</div>
          <p class="text-muted mb-0">Session elapsed time</p>
        </div>
      </div>
      <script>
        (function timer(){
          const startTimestamp = Date.parse('<%= new Date(s.actualStartAt).toISOString() %>');
          const el = document.getElementById('stopwatch');
          if (!el) return;
          const pad = val => String(val).padStart(2, '0');
          function tick(){
            const diff = Math.max(0, Date.now() - startTimestamp);
            const hrs = Math.floor(diff / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            el.textContent = `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
          }
          tick();
          setInterval(tick, 1000);
        })();
      </script>
    <% } %>

    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
        <h2 class="h6 text-uppercase text-muted mb-0">Ratings</h2>
        <% if (s.status === 'completed') { %>
          <span class="badge bg-light text-dark"><i class="fas fa-star me-1"></i>Feedback phase</span>
        <% } %>
      </div>
      <div class="card-body">
        <% if (s.status === 'completed' && user && (s.teacherId === user.id || s.studentId === user.id)) { %>
          <form method="POST" action="/ratings/<%= s.id %>" class="mb-4">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="rateeId" value="<%= user && s.teacherId === user.id ? s.studentId : s.teacherId %>">
            <div class="row g-3">
              <% ['communication','skill','attitude','punctuality'].forEach(field => { %>
                <div class="col-6 col-md-3">
                  <label class="form-label text-capitalize"><%= field %></label>
                  <select class="form-select" name="<%= field %>" required>
                    <option value="">Select</option>
                    <% [1,2,3,4,5].forEach(score => { %>
                      <option value="<%= score %>"><%= score %></option>
                    <% }) %>
                  </select>
                </div>
              <% }) %>
              <div class="col-12">
                <label class="form-label">Comment (optional)</label>
                <textarea class="form-control" name="comment" rows="2" maxlength="500" placeholder="Share any highlights or improvements"></textarea>
              </div>
              <div class="col-12">
                <button class="btn btn-primary"><i class="fas fa-paper-plane me-1"></i>Submit rating</button>
              </div>
            </div>
          </form>
        <% } %>

        <% if (!Array.isArray(s.ratings) || !s.ratings.length) { %>
          <div class="text-muted small">No ratings received yet.</div>
        <% } else { %>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr class="text-muted small">
                  <th>From</th>
                  <th>To</th>
                  <th>Communication</th>
                  <th>Skill</th>
                  <th>Attitude</th>
                  <th>Punctuality</th>
                  <th>Comment</th>
                </tr>
              </thead>
              <tbody>
                <% s.ratings.forEach(r => { %>
                  <tr>
                    <td><%= r.rater?.name || '-' %></td>
                    <td><%= r.ratee?.name || '-' %></td>
                    <td><%= r.communication %></td>
                    <td><%= r.skill %></td>
                    <td><%= r.attitude %></td>
                    <td><%= r.punctuality %></td>
                    <td style="white-space: pre-wrap;"><%= r.comment || '' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h6 text-uppercase text-muted mb-3">Quick contacts</h2>
        <% if (user && (s.teacherId === user.id || s.studentId === user.id)) { %>
          <% const counterpart = user.id === s.teacherId ? s.student : s.teacher; %>
          <p class="mb-2">Reach out to <strong><%= counterpart?.name || 'your partner' %></strong>:</p>
          <div class="d-flex flex-wrap gap-2">
            <% if (counterpart?.whatsapp_number) { %>
              <a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="https://wa.me/<%= counterpart.whatsapp_number %>"><i class="fab fa-whatsapp me-1"></i>WhatsApp</a>
            <% } %>
            <% if (counterpart?.email) { %>
              <a class="btn btn-sm btn-outline-primary" href="mailto:<%= counterpart.email %>?subject=SkillSwap%20Session"><i class="fas fa-envelope me-1"></i>Email</a>
            <% } %>
          </div>
        <% } else { %>
          <p class="text-muted small mb-0">Only participants can contact each other.</p>
        <% } %>
      </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h6 text-uppercase text-muted mb-3">Tips & reports</h2>
        <% if (user && (s.teacherId === user.id || s.studentId === user.id)) { %>
          <% const otherUserId = (user.id === s.teacherId) ? s.studentId : s.teacherId; %>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-secondary btn-sm js-tip" data-user-id="<%= otherUserId %>" data-user-name="<%= user.id === s.teacherId ? s.student?.name : s.teacher?.name %>"><i class="fas fa-gift me-1"></i>Send tip</button>
            <button class="btn btn-outline-danger btn-sm js-report" data-target-id="<%= otherUserId %>" data-target-name="<%= user.id === s.teacherId ? s.student?.name : s.teacher?.name %>" data-session-id="<%= s.id %>"><i class="fas fa-flag me-1"></i>Report</button>
            <a class="btn btn-outline-primary btn-sm" href="/tips"><i class="fas fa-wallet me-1"></i>My tips</a>
          </div>
        <% } else { %>
          <p class="text-muted small mb-0">Tip or report options appear for session participants.</p>
        <% } %>
      </div>
    </div>
  </div>
</div>
