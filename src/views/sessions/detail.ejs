<% const s=session || {}; const fmt=value=> value ? new Date(value).toLocaleString('en-MY', { dateStyle: 'medium',
  timeStyle: 'short' }) : '-';
  const isTeacher = user && s.teacherId === user.id;
  const isLearner = user && s.studentId === user.id;
  const myRole = isTeacher ? 'Teacher' : isLearner ? 'Learner' : 'Viewer';
  const partnerRole = isTeacher ? 'Learner' : 'Teacher';
  const partner = isTeacher ? s.student : s.teacher;

  const statusSteps = ['requested', 'confirmed', 'in_progress', 'completed'];
  const currentStepIndex = statusSteps.indexOf(s.status);
  const isCancelled = s.status === 'cancelled';

  const statusConfig = {
  requested: { icon: 'fa-clock', color: 'warning', label: 'Requested' },
  confirmed: { icon: 'fa-check-circle', color: 'primary', label: 'Confirmed' },
  in_progress: { icon: 'fa-play-circle', color: 'info', label: 'In Progress' },
  completed: { icon: 'fa-trophy', color: 'success', label: 'Completed' },
  cancelled: { icon: 'fa-ban', color: 'secondary', label: 'Cancelled' }
  };
  const currentStatus = statusConfig[s.status] || statusConfig.requested;
  %>

  <!-- Hero Header -->
  <div class="card border-0 shadow-sm mb-4 overflow-hidden">
    <div class="card-body p-0">
      <!-- Status Banner -->
      <div
        class="bg-<%= currentStatus.color %> <%= s.status === 'in_progress' ? 'text-dark' : 'text-white' %> px-4 py-3">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
          <div>
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="fas <%= currentStatus.icon %> fa-lg"></i>
              <span class="fw-bold fs-5 text-uppercase">
                <%= currentStatus.label %>
              </span>
            </div>
            <small class="opacity-75">Session ID: #<%= s.id %></small>
          </div>
          <% if (isTeacher || isLearner) { %>
            <div class="d-flex align-items-center gap-2 bg-white bg-opacity-25 rounded-pill px-3 py-2">
              <i class="fas <%= isTeacher ? 'fa-chalkboard-teacher' : 'fa-user-graduate' %>"></i>
              <span class="fw-semibold">You are the <%= myRole %></span>
            </div>
            <% } %>
        </div>
      </div>

      <!-- Main Info -->
      <div class="p-4">
        <div class="d-flex align-items-start justify-content-between mb-3">
          <a class="btn btn-sm btn-outline-secondary" href="javascript:history.back()">
            <i class="fas fa-arrow-left me-1"></i>Back
          </a>
        </div>

        <h1 class="h3 fw-bold mb-2">
          <i class="fas fa-book-open text-primary me-2"></i>
          <%= s.Skill?.name || 'Skill Session' %>
        </h1>

        <div class="row g-3 mt-3">
          <div class="col-6 col-md-3">
            <div class="bg-light rounded-3 p-3 text-center h-100">
              <i class="fas fa-chalkboard-teacher text-success mb-2 fa-lg"></i>
              <div class="small text-muted">Teacher</div>
              <div class="fw-semibold">
                <%= s.teacher?.name || 'Pending' %>
              </div>
              <% if (isTeacher) { %><span class="badge bg-success mt-1">You</span>
                <% } %>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="bg-light rounded-3 p-3 text-center h-100">
              <i class="fas fa-user-graduate text-primary mb-2 fa-lg"></i>
              <div class="small text-muted">Learner</div>
              <div class="fw-semibold">
                <%= s.student?.name || 'Pending' %>
              </div>
              <% if (isLearner) { %><span class="badge bg-primary mt-1">You</span>
                <% } %>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="bg-light rounded-3 p-3 text-center h-100">
              <i class="fas fa-calendar text-info mb-2 fa-lg"></i>
              <div class="small text-muted">Scheduled</div>
              <div class="fw-semibold small">
                <%= fmt(s.startAt) %>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="bg-light rounded-3 p-3 text-center h-100">
              <i class="fas fa-hourglass-end text-warning mb-2 fa-lg"></i>
              <div class="small text-muted">Until</div>
              <div class="fw-semibold small">
                <%= fmt(s.endAt) %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Progress Stepper (not shown if cancelled) -->
  <% if (!isCancelled) { %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h6 text-uppercase text-muted mb-3"><i class="fas fa-route me-2"></i>Session Progress</h2>
        <div class="d-flex justify-content-between position-relative">
          <!-- Progress Line -->
          <div class="position-absolute"
            style="top: 20px; left: 12%; right: 12%; height: 4px; background: #e9ecef; z-index: 0;">
            <div class="h-100 bg-success"
              style="width: <%= Math.max(0, (currentStepIndex / (statusSteps.length - 1)) * 100) %>%; transition: width 0.5s;">
            </div>
          </div>

          <% statusSteps.forEach((step, idx)=> {
            const isPast = idx < currentStepIndex; const isCurrent=idx===currentStepIndex; const cfg=statusConfig[step];
              %>
              <div class="text-center position-relative" style="z-index: 1; width: 25%;">
                <div
                  class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2 
          <%= isPast || isCurrent ? 'bg-' + cfg.color + (step === 'in_progress' ? ' text-dark' : ' text-white') : 'bg-light text-muted' %>"
                  style="width: 40px; height: 40px;">
                  <i class="fas <%= cfg.icon %>"></i>
                </div>
                <div
                  class="small <%= isCurrent ? 'fw-bold text-' + cfg.color : isPast ? 'text-success' : 'text-muted' %>">
                  <%= cfg.label %>
                </div>
              </div>
              <% }) %>
        </div>
      </div>
    </div>
    <% } %>

      <div class="row g-4">
        <!-- Main Content Column -->
        <div class="col-lg-8">

          <!-- Action Card - Most Important -->
          <div class="card border-0 shadow-sm mb-4 border-start border-4 border-primary">
            <div class="card-header bg-white border-0 pb-0">
              <h2 class="h6 text-uppercase text-primary mb-0">
                <i class="fas fa-bolt me-2"></i>Your Actions
              </h2>
            </div>
            <div class="card-body">
              <% if (s.status==='cancelled' ) { %>
                <div class="alert alert-secondary mb-0">
                  <i class="fas fa-ban me-2"></i>This session has been cancelled. No actions available.
                </div>
                <% } else if (s.status==='completed' ) { %>
                  <div class="alert alert-success mb-0">
                    <i class="fas fa-check-circle me-2"></i>Session completed! Please rate your experience below.
                  </div>
                  <% } else { %>

                    <!-- Teacher: Requested → Confirm -->
                    <% if (s.status==='requested' && isTeacher) { %>
                      <div class="d-grid gap-2">
                        <form method="POST" action="/sessions/<%= s.id %>/confirm">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <button class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-check-circle me-2"></i>Accept Session Request
                          </button>
                        </form>
                        <p class="text-muted text-center small mb-0">
                          <i class="fas fa-info-circle me-1"></i>Accept to confirm this teaching appointment
                        </p>
                      </div>
                      <% } %>

                        <!-- Learner: Requested → Wait -->
                        <% if (s.status==='requested' && isLearner) { %>
                          <div class="alert alert-warning mb-0">
                            <i class="fas fa-clock me-2"></i>
                            <strong>Waiting for teacher confirmation.</strong><br>
                            <small>
                              <%= s.teacher?.name || 'The teacher' %> will confirm or decline your request.
                            </small>
                          </div>
                          <% } %>

                            <!-- Teacher: Confirmed → Generate Code -->
                            <% if (s.status==='confirmed' && isTeacher) { %>
                              <div class="d-grid gap-3">
                                <form method="POST" action="/sessions/<%= s.id %>/generate-code">
                                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                  <button class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-key me-2"></i>Generate Start Code
                                  </button>
                                </form>
                                <% if (s.startCode) { %>
                                  <div class="alert alert-info mb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                      <div>
                                        <small class="text-muted d-block">Current Code</small>
                                        <span class="fs-3 fw-bold font-monospace">
                                          <%= s.startCode %>
                                        </span>
                                      </div>
                                      <div class="text-end">
                                        <small class="text-muted d-block">Expires</small>
                                        <span>
                                          <%= fmt(s.codeExpiresAt) %>
                                        </span>
                                      </div>
                                    </div>
                                    <hr>
                                    <small><i class="fas fa-share-alt me-1"></i>Share this code with your learner to
                                      start the session</small>
                                  </div>
                                  <% } else { %>
                                    <p class="text-muted text-center small mb-0">
                                      <i class="fas fa-info-circle me-1"></i>Generate a code and share it with your
                                      learner when you're ready to start
                                    </p>
                                    <% } %>
                              </div>
                              <% } %>

                                <!-- Learner: Confirmed → Enter Code -->
                                <% if (s.status==='confirmed' && isLearner) { %>
                                  <form method="POST" action="/sessions/<%= s.id %>/verify-code">
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                    <div class="alert alert-info mb-3">
                                      <i class="fas fa-key me-2"></i>
                                      <strong>Ready to start!</strong> Ask your teacher for the start code.
                                    </div>
                                    <div class="input-group input-group-lg">
                                      <span class="input-group-text bg-light"><i class="fas fa-key"></i></span>
                                      <input name="code" class="form-control text-center fw-bold fs-4 font-monospace"
                                        placeholder="Enter code" pattern="\d{3,6}" required maxlength="6">
                                      <button class="btn btn-success px-4" type="submit">
                                        <i class="fas fa-play me-1"></i>Start
                                      </button>
                                    </div>
                                  </form>
                                  <% } %>

                                    <!-- Teacher: In Progress → End Session -->
                                    <% if (s.status==='in_progress' && isTeacher) { %>
                                      <div class="d-grid gap-3">
                                        <form method="POST" action="/sessions/<%= s.id %>/end">
                                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                          <button class="btn btn-success btn-lg w-100">
                                            <i class="fas fa-flag-checkered me-2"></i>End Session
                                          </button>
                                        </form>
                                        <p class="text-muted text-center small mb-0">
                                          <i class="fas fa-info-circle me-1"></i>This will complete the session and
                                          award points to both participants
                                        </p>
                                      </div>
                                      <% } %>

                                        <!-- Learner: In Progress → Waiting -->
                                        <% if (s.status==='in_progress' && isLearner) { %>
                                          <div class="alert alert-info mb-0">
                                            <i class="fas fa-play-circle me-2"></i>
                                            <strong>Session in progress!</strong><br>
                                            <small>The teacher will end the session when complete.</small>
                                          </div>
                                          <% } %>

                                            <!-- Cancel Button (for all non-completed) -->
                                            <% if (s.status !=='completed' && (isTeacher || isLearner)) { %>
                                              <hr class="my-4">
                                              <form method="POST" action="/sessions/<%= s.id %>/cancel"
                                                class="text-center">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <button class="btn btn-outline-danger">
                                                  <i class="fas fa-times me-1"></i>Cancel Session
                                                </button>
                                              </form>
                                              <% } %>

                                                <% } %>
            </div>
          </div>

          <!-- Live Timer (In Progress) -->
          <% if (s.status==='in_progress' && s.actualStartAt) { %>
            <div class="card border-0 shadow-sm mb-4 bg-info bg-opacity-10">
              <div class="card-body text-center py-4">
                <i class="fas fa-stopwatch fa-2x text-info mb-2"></i>
                <p class="text-uppercase text-muted small mb-1">Session Duration</p>
                <div class="display-4 fw-bold text-info" id="stopwatch">00:00:00</div>
                <p class="text-muted small mb-0">Session started at <%= fmt(s.actualStartAt) %>
                </p>
              </div>
            </div>
            <script>
              (function timer() {
                const startTimestamp = Date.parse('<%= new Date(s.actualStartAt).toISOString() %>');
                const el = document.getElementById('stopwatch');
                if (!el) return;
                const pad = val => String(val).padStart(2, '0');
                function tick() {
                  const diff = Math.max(0, Date.now() - startTimestamp);
                  const hrs = Math.floor(diff / 3600000);
                  const mins = Math.floor((diff % 3600000) / 60000);
                  const secs = Math.floor((diff % 60000) / 1000);
                  el.textContent = `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
                }
                tick();
                setInterval(tick, 1000);
              })();
            </script>
            <% } %>

              <!-- Ratings Section -->
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                  <h2 class="h6 text-uppercase text-muted mb-0">
                    <i class="fas fa-star me-2"></i>Ratings & Feedback
                  </h2>
                  <% if (s.status==='completed' ) { %>
                    <span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>Feedback Time!</span>
                    <% } %>
                </div>
                <div class="card-body">
                  <% const userRating=s.ratings && s.ratings.find(r=> r.raterId === user.id); %>

                    <% if (s.status==='completed' && (isTeacher || isLearner)) { %>
                      <% if (!userRating) { %>
                        <form method="POST" action="/ratings/<%= s.id %>" class="mb-4">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <input type="hidden" name="rateeId" value="<%= isTeacher ? s.studentId : s.teacherId %>">

                          <div class="alert alert-warning mb-3">
                            <i class="fas fa-star me-2"></i>
                            <strong>Rate your <%= isTeacher ? 'learner' : 'teacher' %>!</strong>
                            Your feedback helps improve the community.
                          </div>

                          <div class="row g-3 mb-3">
                            <% ['communication', 'skill' , 'attitude' , 'punctuality' ].forEach(field=> { %>
                              <div class="col-6 col-md-3">
                                <label class="form-label small text-muted text-capitalize">
                                  <%= field %>
                                </label>
                                <select class="form-select" name="<%= field %>" required>
                                  <option value="">-</option>
                                  <% [5,4,3,2,1].forEach(score=> { %>
                                    <option value="<%= score %>">
                                      <%= '★' .repeat(score) %>
                                    </option>
                                    <% }) %>
                                </select>
                              </div>
                              <% }) %>
                          </div>

                          <div class="mb-3">
                            <label class="form-label small text-muted">Comment (optional)</label>
                            <textarea class="form-control" name="comment" rows="2" maxlength="500"
                              placeholder="Share your experience..."></textarea>
                          </div>

                          <button class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i>Submit Rating
                          </button>
                        </form>
                        <% } else { %>
                          <div class="alert alert-success mb-4">
                            <i class="fas fa-check-circle me-2"></i>You have already rated this session. Thank you!
                          </div>
                          <% } %>
                            <% } %>

                              <!-- Existing Ratings -->
                              <% if (!Array.isArray(s.ratings) || !s.ratings.length) { %>
                                <p class="text-muted small mb-0"><i class="fas fa-info-circle me-1"></i>No ratings yet.
                                </p>
                                <% } else { %>
                                  <div class="table-responsive">
                                    <table class="table table-sm align-middle mb-0">
                                      <thead class="table-light">
                                        <tr class="small text-muted">
                                          <th>From</th>
                                          <th>To</th>
                                          <th class="text-center">Avg</th>
                                          <th>Comment</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <% s.ratings.forEach(r=> {
                                          const avg = ((r.communication + r.skill + r.attitude + r.punctuality) /
                                          4).toFixed(1);
                                          %>
                                          <tr>
                                            <td>
                                              <%= r.rater?.name || '-' %>
                                            </td>
                                            <td>
                                              <%= r.ratee?.name || '-' %>
                                            </td>
                                            <td class="text-center">
                                              <span class="badge bg-warning text-dark">
                                                <%= avg %> ★
                                              </span>
                                            </td>
                                            <td>
                                              <%= r.comment || '-' %>
                                            </td>
                                          </tr>
                                          <% }) %>
                                      </tbody>
                                    </table>
                                  </div>
                                  <% } %>
                </div>
              </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <!-- Quick Contact -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pb-0">
              <h2 class="h6 text-uppercase text-muted mb-0">
                <i class="fas fa-address-book me-2"></i>Contact <%= partnerRole %>
              </h2>
            </div>
            <div class="card-body">
              <% if (isTeacher || isLearner) { %>
                <div class="d-flex align-items-center gap-3 mb-3">
                  <div class="bg-light rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 50px; height: 50px;">
                    <i class="fas fa-user fa-lg text-muted"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">
                      <%= partner?.name || 'Unknown' %>
                    </div>
                    <small class="text-muted">
                      <%= partnerRole %>
                    </small>
                  </div>
                </div>
                <div class="d-grid gap-2">
                  <% if (partner?.whatsapp_number) { %>
                    <a class="btn btn-success btn-sm" target="_blank" rel="noopener"
                      href="https://wa.me/<%= partner.whatsapp_number %>">
                      <i class="fab fa-whatsapp me-1"></i>WhatsApp
                    </a>
                    <% } else if (partner?.email) { %>
                      <% const skillName=s.Skill?.name || 'our session' ; const
                        sessionEmailSubject=encodeURIComponent(`SkillSwap MY - About our ${skillName} session`); const
                        sessionEmailBody=encodeURIComponent( `Hi ${partner.name},\n\n` + `I'm reaching out regarding our
                        ${skillName} session on SkillSwap MY.\n\n` + `Session Details:\n` + `- Skill: ${skillName}\n` +
                        `- Scheduled: ${new Date(s.startAt).toLocaleString('en-MY', { dateStyle: 'medium' ,
                        timeStyle: 'short' })}\n\n` + `Please let me know if you have any questions or need to discuss
                        anything.\n\n` + `Best regards,\n${user.name || 'Your SkillSwap partner' }` ); %>
                        <a class="btn btn-primary btn-sm"
                          href="mailto:<%= partner.email %>?subject=<%= sessionEmailSubject %>&body=<%= sessionEmailBody %>">
                          <i class="fas fa-envelope me-1"></i>Email
                        </a>
                        <% } else { %>
                          <button class="btn btn-outline-secondary btn-sm" disabled>
                            <i class="fas fa-user-slash me-1"></i>No contact info
                          </button>
                          <% } %>
                </div>
                <% } else { %>
                  <p class="text-muted small mb-0">Contact info visible to participants only.</p>
                  <% } %>
            </div>
          </div>

          <!-- Tips & Reports -->
          <% if (isTeacher || isLearner) { %>
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white border-0 pb-0">
                <h2 class="h6 text-uppercase text-muted mb-0">
                  <i class="fas fa-gift me-2"></i>Tips & Reports
                </h2>
              </div>
              <div class="card-body">
                <% const otherUserId=isTeacher ? s.studentId : s.teacherId; %>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-warning btn-sm js-tip" data-user-id="<%= otherUserId %>"
                      data-user-name="<%= partner?.name %>">
                      <i class="fas fa-coins me-1"></i>Send Tip
                    </button>
                    <button class="btn btn-outline-danger btn-sm js-report" data-target-id="<%= otherUserId %>"
                      data-target-name="<%= partner?.name %>" data-session-id="<%= s.id %>">
                      <i class="fas fa-flag me-1"></i>Report Issue
                    </button>
                    <a class="btn btn-outline-secondary btn-sm" href="/tips">
                      <i class="fas fa-wallet me-1"></i>My Tips
                    </a>
                  </div>
              </div>
            </div>
            <% } %>

              <!-- Session Times (Actual) -->
              <% if (s.actualStartAt || s.actualEndAt) { %>
                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-white border-0 pb-0">
                    <h2 class="h6 text-uppercase text-muted mb-0">
                      <i class="fas fa-history me-2"></i>Actual Times
                    </h2>
                  </div>
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <span class="text-muted">Started</span>
                      <span class="fw-semibold">
                        <%= fmt(s.actualStartAt) %>
                      </span>
                    </div>
                    <% if (s.actualEndAt) { %>
                      <div class="d-flex justify-content-between">
                        <span class="text-muted">Ended</span>
                        <span class="fw-semibold">
                          <%= fmt(s.actualEndAt) %>
                        </span>
                      </div>
                      <% } %>
                  </div>
                </div>
                <% } %>
        </div>
      </div>