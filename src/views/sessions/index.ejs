<% const teaching=Array.isArray(teachingSessions) ? teachingSessions : []; const
  learning=Array.isArray(learningSessions) ? learningSessions : []; const fmt=d=> d ? new Date(d).toLocaleString() : '';

  const badge = (status) => {
  if (status === 'requested') return 'bg-warning text-dark';
  if (status === 'confirmed') return 'bg-primary text-white';
  if (status === 'in_progress') return 'bg-info text-dark';
  if (status === 'completed') return 'bg-success text-white';
  if (status === 'cancelled') return 'bg-secondary text-white';
  if (status === 'expired') return 'bg-danger text-white';
  return 'bg-light text-dark';
  };

  const badgeStyle = (status) => {
  if (status === 'requested') return 'background-color: #ffc107 !important; color: #212529 !important;';
  if (status === 'confirmed') return 'background-color: #0d6efd !important; color: #fff !important;';
  if (status === 'in_progress') return 'background-color: #0dcaf0 !important; color: #212529 !important;';
  if (status === 'completed') return 'background-color: #198754 !important; color: #fff !important;';
  if (status === 'cancelled') return 'background-color: #6c757d !important; color: #fff !important;';
  if (status === 'expired') return 'background-color: #dc3545 !important; color: #fff !important;';
  return 'background-color: #f8f9fa !important; color: #212529 !important;';
  };

  const badgeLabel = (session) => {
  if (!session || !session.status) return 'UNKNOWN';
  if (session.status === 'cancelled' && new Date(session.startAt) < new Date()) return 'EXPIRED' ; if
    (session.status==='completed' ) return 'COMPLETED' ; if (session.status==='in_progress' ) return 'IN PROGRESS' ; if
    (session.status==='confirmed' ) return 'CONFIRMED' ; if (session.status==='requested' ) return 'PENDING' ; if
    (session.status==='cancelled' ) return 'CANCELLED' ; return session.status.toUpperCase().replace('_', ' ' ); };
    const badgeClass=(session)=> {
    if (!session || !session.status) return 'bg-light text-dark';
    if (session.status === 'cancelled' && new Date(session.startAt) < new Date()) return 'bg-danger' ; return
      badge(session.status); }; %>

      <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
        <h1 class="h4 mb-0">My Sessions</h1>
      </div>

      <!-- Request a Session (manual IDs for now) -->
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="h6 text-muted mb-3">Request a Session</h2>
          <form method="POST" action="/sessions/request" class="row g-2">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <div class="col-12 col-md-3">
              <label class="form-label">Teacher ID</label>
              <input type="number" class="form-control" name="teacherId" placeholder="e.g. 12" required>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Skill ID</label>
              <input type="number" class="form-control" name="skillId" placeholder="e.g. 5" required>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Start</label>
              <input type="datetime-local" class="form-control" name="startAt" required>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">End</label>
              <input type="datetime-local" class="form-control" name="endAt" required>
            </div>
            <div class="col-12 mt-1 d-grid d-md-block">
              <button class="btn btn-primary">Request</button>
            </div>
          </form>
          <div class="form-text mt-2">
            Tip: Use Browse to find a teacher and note their ID and skill.
          </div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Teaching -->
        <div class="col-12 col-lg-6">
          <div class="card">
            <div class="card-body">
              <h2 class="h6 text-muted mb-3">Teaching</h2>

              <% if (teaching.length===0) { %>
                <div class="text-muted small">No sessions.</div>
                <% } else { %>
                  <div class="list-group">
                    <% teaching.forEach(s=> { %>
                      <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                          <div class="me-3">
                            <div class="d-flex align-items-center">
                              <span class="badge <%= badgeClass(s) %> me-2" style="<%= badgeStyle(s.status) %>">
                                <%= badgeLabel(s) %>
                              </span>
                              <strong>
                                <%= s.Skill?.name || 'Skill' %>
                              </strong>
                            </div>
                            <div class="small text-muted mt-1">
                              With learner: <%= s.student?.name || 'User' %>
                            </div>
                            <div class="small text-muted">
                              <%= fmt(s.startAt) %> - <%= fmt(s.endAt) %>
                            </div>
                          </div>
                          <div class="text-end">
                            <a class="btn btn-outline-secondary btn-sm mb-1" href="/sessions/<%= s.id %>">View</a>
                            <div>
                              <% if (s.status==='requested' ) { %>
                                <form method="POST" action="/sessions/<%= s.id %>/confirm" class="d-inline">
                                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                  <button class="btn btn-primary btn-sm">Confirm</button>
                                </form>
                                <form method="POST" action="/sessions/<%= s.id %>/cancel" class="d-inline">
                                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                  <button class="btn btn-outline-danger btn-sm">Cancel</button>
                                </form>
                                <% } else if (s.status==='confirmed' ) { %>
                                  <form method="POST" action="/sessions/<%= s.id %>/generate-code" class="d-inline">
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                    <button class="btn btn-primary btn-sm">Generate Code</button>
                                  </form>
                                  <form method="POST" action="/sessions/<%= s.id %>/cancel" class="d-inline">
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                    <button class="btn btn-outline-danger btn-sm">Cancel</button>
                                  </form>
                                  <% } else if (s.status==='in_progress' ) { %>
                                    <form method="POST" action="/sessions/<%= s.id %>/end" class="d-inline">
                                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                      <button class="btn btn-success btn-sm">End Session</button>
                                    </form>
                                    <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                      <% }) %>
                  </div>
                  <% } %>
            </div>
          </div>
        </div>

        <!-- Learning -->
        <div class="col-12 col-lg-6">
          <div class="card">
            <div class="card-body">
              <h2 class="h6 text-muted mb-3">Learning</h2>

              <% if (learning.length===0) { %>
                <div class="text-muted small">No sessions.</div>
                <% } else { %>
                  <div class="list-group">
                    <% learning.forEach(s=> { %>
                      <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                          <div class="me-3">
                            <div class="d-flex align-items-center">
                              <span class="badge <%= badgeClass(s) %> me-2" style="<%= badgeStyle(s.status) %>">
                                <%= badgeLabel(s) %>
                              </span>
                              <strong>
                                <%= s.Skill?.name || 'Skill' %>
                              </strong>
                            </div>
                            <div class="small text-muted mt-1">
                              With teacher: <%= s.teacher?.name || 'User' %>
                            </div>
                            <div class="small text-muted">
                              <%= fmt(s.startAt) %> - <%= fmt(s.endAt) %>
                            </div>
                          </div>
                          <div class="text-end">
                            <a class="btn btn-outline-secondary btn-sm mb-1" href="/sessions/<%= s.id %>">View</a>
                            <div>
                              <% if (s.status==='requested' ) { %>
                                <form method="POST" action="/sessions/<%= s.id %>/cancel" class="d-inline">
                                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                  <button class="btn btn-outline-danger btn-sm">Cancel</button>
                                </form>
                                <% } else if (s.status==='confirmed' ) { %>
                                  <!-- Enter code on session detail page -->
                                  <form method="POST" action="/sessions/<%= s.id %>/cancel" class="d-inline">
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                    <button class="btn btn-outline-danger btn-sm">Cancel</button>
                                  </form>
                                  <% } else if (s.status==='in_progress' ) { %>
                                    <span class="badge bg-info text-dark">In progress</span>
                                    <% } %>
                            </div>
                          </div>
                        </div>
                      </div>
                      <% }) %>
                  </div>
                  <% } %>
            </div>
          </div>
        </div>
      </div>