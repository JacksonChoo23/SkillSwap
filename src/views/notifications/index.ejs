<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Notifications</h1>
    <a href="/profile" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left me-1"></i> Back to Profile
    </a>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Inbox</span>
          <div class="btn-group btn-group-sm" role="group">
            <button id="refreshBtn" type="button" class="btn btn-outline-primary">
              <i class="fas fa-rotate me-1"></i> Refresh
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="notificationsList" class="list-group">
            <div class="text-center text-muted py-5">
              <i class="fas fa-inbox fa-2x mb-2"></i>
              <p class="mb-0">Loading notifications...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card">
        <div class="card-body">
          <h2 class="h6 text-muted mb-3">Tips</h2>
          <ul class="small text-muted mb-0">
            <li>Unread notifications are shown in bold.</li>
            <li>Click a notification to mark it as read.</li>
            <li>Use Refresh to get the latest updates.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const csrfToken = '<%= csrfToken %>';

  async function fetchNotifications() {
    const res = await fetch('/listings/api/notifications', {
      cache: 'no-store',
      headers: { 'Cache-Control': 'no-cache' }
    });
    if (!res.ok) throw new Error('Failed to fetch notifications');
    const data = await res.json();
    return data.notifications || [];
  }

  async function markRead(id) {
    await fetch(`/listings/api/notifications/${id}/read`, {
      method: 'POST',
      cache: 'no-store',
      headers: {
        'CSRF-Token': csrfToken,
        'Cache-Control': 'no-cache'
      }
    });
  }

  function renderNotifications(notifications) {
    const list = document.getElementById('notificationsList');
    list.innerHTML = '';

    if (!notifications.length) {
      list.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-inbox fa-2x mb-2"></i><p class="mb-0">No notifications.</p></div>';
      return;
    }

    notifications.forEach(n => {
      const a = document.createElement('a');
      a.href = '#';
      a.className = `list-group-item list-group-item-action ${n.status === 'unread' ? 'fw-bold' : ''}`;
      a.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <span>${n.title || 'Notification'}</span>
          <small class="text-muted">${new Date(n.created_at || n.createdAt).toLocaleString()}</small>
        </div>
        <p class="mb-0 small text-muted">${n.message || ''}</p>
      `;
      a.addEventListener('click', async (e) => {
        e.preventDefault();
        if (n.status === 'unread') {
          try {
            await markRead(n.id);
            a.classList.remove('fw-bold');
          } catch (err) {
            console.error('Mark read failed', err);
          }
        }
      });
      list.appendChild(a);
    });
  }

  async function load() {
    try {
      const notifications = await fetchNotifications();
      renderNotifications(notifications);
    } catch (err) {
      const list = document.getElementById('notificationsList');
      list.innerHTML = '<div class="alert alert-danger">Failed to load notifications.</div>';
      console.error(err);
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', load);
  load();
</script>
