<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0 text-gray-800">Manage Categories</h1>
</div>

<!-- Search and Filter -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <form method="GET" action="/admin/categories" class="row g-3 align-items-end">
      <div class="col-md-5">
        <label class="form-label small text-muted">Search</label>
        <input type="text" name="search" class="form-control" placeholder="Search by category name..."
          value="<%= search || '' %>">
      </div>
      <div class="col-md-3">
        <label class="form-label small text-muted">Status</label>
        <select name="status" class="form-select">
          <option value="">All Statuses</option>
          <option value="active" <%=status==='active' ? 'selected' : '' %>>Active</option>
          <option value="inactive" <%=status==='inactive' ? 'selected' : '' %>>Inactive</option>
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-search me-1"></i> Filter
        </button>
      </div>
      <div class="col-md-2">
        <a href="/admin/categories" class="btn btn-outline-secondary w-100">
          <i class="fas fa-times me-1"></i> Clear
        </a>
      </div>
    </form>
  </div>
</div>

<div class="row mb-4">
  <!-- Add New Category -->
  <div class="col-lg-6 mb-3 mb-lg-0">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header bg-white py-3">
        <h6 class="m-0 fw-bold text-primary">Add New Category</h6>
      </div>
      <div class="card-body">
        <form method="POST" action="/admin/categories" class="row g-3 align-items-end">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="col-12">
            <label class="form-label fw-bold">Category Name</label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="fas fa-tag"></i></span>
              <input type="text" name="name" class="form-control" minlength="2" required
                placeholder="e.g., Programming">
            </div>
          </div>
          <div class="col-12">
            <button class="btn btn-primary w-100">
              <i class="fas fa-plus me-1"></i> Add Category
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add New Skill -->
  <div class="col-lg-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header bg-white py-3">
        <h6 class="m-0 fw-bold text-success">Add New Skill</h6>
      </div>
      <div class="card-body">
        <form method="POST" action="/admin/skills" class="row g-3 align-items-end">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="col-12">
            <label class="form-label fw-bold">Skill Name</label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="fas fa-lightbulb"></i></span>
              <input type="text" name="name" class="form-control" minlength="2" required placeholder="e.g., JavaScript">
            </div>
          </div>
          <div class="col-12">
            <label class="form-label fw-bold">Category</label>
            <select name="categoryId" class="form-select" required>
              <option value="">Select Category</option>
              <% if (categories && categories.length> 0) { %>
                <% categories.forEach(c=> { %>
                  <% if (c.isActive) { %>
                    <option value="<%= c.id %>">
                      <%= c.name %>
                    </option>
                    <% } %>
                      <% }) %>
                        <% } %>
            </select>
          </div>
          <div class="col-12">
            <button class="btn btn-success w-100">
              <i class="fas fa-plus me-1"></i> Add Skill
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body p-0">
    <% if (!categories || categories.length===0) { %>
      <div class="p-4 text-center text-muted">
        <i class="fas fa-folder-open fa-3x mb-3 text-secondary"></i>
        <p class="mb-0">No categories found.</p>
      </div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4" style="width: 40%;">Name</th>
                <th style="width: 15%;">Status</th>
                <th style="width: 20%;">Skills Count</th>
                <th class="text-center pe-4" style="width: 25%;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% categories.forEach(c=> { %>
                <tr>
                  <td class="ps-4 fw-bold text-dark">
                    <%= c.name %>
                  </td>
                  <td>
                    <span class="badge rounded-pill <%= c.isActive ? 'bg-success' : 'bg-secondary' %>">
                      <%= c.isActive ? 'Active' : 'Inactive' %>
                    </span>
                  </td>
                  <td>
                    <% if (Array.isArray(c.skills) && c.skills.length) { %>
                      <button class="badge bg-primary border-0 skills-count-btn" style="cursor: pointer;"
                        data-bs-toggle="modal" data-bs-target="#skillsModal" data-category-name="<%= c.name %>"
                        data-skills='<%- JSON.stringify(c.skills) %>'>
                        <%= c.skills.length %> <i class="fas fa-eye ms-1"></i>
                      </button>
                      <% } else { %>
                        <span class="text-muted small">-</span>
                        <% } %>
                  </td>
                  <td class="text-center pe-4">
                    <div class="btn-group" role="group">
                      <button class="btn btn-sm btn-outline-primary edit-category-btn" data-bs-toggle="modal"
                        data-bs-target="#editCategoryModal" data-category-id="<%= c.id %>"
                        data-category-name="<%= c.name %>">
                        <i class="fas fa-edit"></i>
                        <span class="d-none d-md-inline-block ms-1">Edit</span>
                      </button>
                      <form method="POST" action="/admin/categories/<%= c.id %>/toggle" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm <%= c.isActive ? 'btn-outline-warning' : 'btn-outline-success' %>">
                          <i class="fas <%= c.isActive ? 'fa-pause' : 'fa-play' %>"></i>
                          <span class="d-none d-md-inline-block ms-1">
                            <%= c.isActive ? 'Pause' : 'Activate' %>
                          </span>
                        </button>
                      </form>
                      <button class="btn btn-sm btn-outline-danger delete-category-btn" data-category-id="<%= c.id %>"
                        data-category-name="<%= c.name %>" data-skill-count="<%= c.skills ? c.skills.length : 0 %>">
                        <i class="fas fa-trash"></i>
                        <span class="d-none d-md-inline-block ms-1">Delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>
        <div class="p-3 border-top">
          <%- include('../partials/pagination') %>
        </div>
        <% } %>
  </div>
</div>

<!-- Skills Modal -->
<div class="modal fade" id="skillsModal" tabindex="-1" aria-labelledby="skillsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="skillsModalLabel">
          <i class="fas fa-lightbulb me-2"></i>Skills in <span id="categoryName"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="skillsList" class="row g-2">
          <!-- Skills will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="editCategoryForm" action="">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="editCategoryModalLabel">
            <i class="fas fa-edit me-2"></i>Edit Category
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editCategoryName" class="form-label fw-bold">Category Name</label>
            <input type="text" class="form-control" id="editCategoryName" name="name" required minlength="2">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Skill Modal -->
<div class="modal fade" id="editSkillModal" tabindex="-1" aria-labelledby="editSkillModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="editSkillForm" action="">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="editSkillModalLabel">
            <i class="fas fa-edit me-2"></i>Edit Skill
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editSkillName" class="form-label fw-bold">Skill Name</label>
            <input type="text" class="form-control" id="editSkillName" name="name" required minlength="2">
          </div>
          <div class="mb-3">
            <label for="editSkillCategory" class="form-label fw-bold">Category</label>
            <select class="form-select" id="editSkillCategory" name="categoryId" required>
              <option value="">Select Category</option>
              <% if (categories && categories.length> 0) { %>
                <% categories.forEach(c=> { %>
                  <% if (c.isActive) { %>
                    <option value="<%= c.id %>">
                      <%= c.name %>
                    </option>
                    <% } %>
                      <% }) %>
                        <% } %>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Use event delegation to avoid CSP violations
  document.addEventListener('DOMContentLoaded', function () {
    // Add event listeners to all skill count buttons
    document.querySelectorAll('.skills-count-btn').forEach(function (button) {
      button.addEventListener('click', function () {
        const categoryName = this.getAttribute('data-category-name');
        const skillsData = this.getAttribute('data-skills');

        try {
          const skills = JSON.parse(skillsData);
          showSkills(categoryName, skills);
        } catch (e) {
          console.error('Error parsing skills data:', e);
        }
      });
    });

    // Edit category buttons
    document.querySelectorAll('.edit-category-btn').forEach(function (button) {
      button.addEventListener('click', function () {
        const categoryId = this.getAttribute('data-category-id');
        const categoryName = this.getAttribute('data-category-name');

        document.getElementById('editCategoryName').value = categoryName;
        document.getElementById('editCategoryForm').action = '/admin/categories/' + categoryId + '/update';
      });
    });

    // Delete category buttons
    document.querySelectorAll('.delete-category-btn').forEach(function (button) {
      button.addEventListener('click', function () {
        const categoryId = this.getAttribute('data-category-id');
        const categoryName = this.getAttribute('data-category-name');
        const skillCount = parseInt(this.getAttribute('data-skill-count') || 0);

        let message = `Are you sure you want to delete the category "${categoryName}"?`;
        if (skillCount > 0) {
          message += ` This category has ${skillCount} skill(s) associated with it. They will also be affected.`;
        }

        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'Delete Category?',
            text: message,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it',
            cancelButtonText: 'Cancel'
          }).then((result) => {
            if (result.isConfirmed) {
              // Create and submit form
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = '/admin/categories/' + categoryId + '/delete';

              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = '_csrf';
              csrfInput.value = document.querySelector('input[name="_csrf"]').value;
              form.appendChild(csrfInput);

              document.body.appendChild(form);
              form.submit();
            }
          });
        } else {
          if (confirm(message)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/categories/' + categoryId + '/delete';

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = document.querySelector('input[name="_csrf"]').value;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
          }
        }
      });
    });
  });

  function showSkills(categoryName, skills) {
    document.getElementById('categoryName').textContent = categoryName;

    const skillsList = document.getElementById('skillsList');
    if (!skills || skills.length === 0) {
      skillsList.innerHTML = '<div class="col-12 text-center text-muted">No skills found.</div>';
      return;
    }

    skillsList.innerHTML = skills.map((skill, index) => `
    <div class="col-md-6 col-lg-4">
      <div class="card border shadow-sm h-100">
        <div class="card-body p-3">
          <div class="d-flex align-items-start mb-3">
            <div class="flex-shrink-0">
              <div class="rounded-circle bg-primary bg-opacity-10 p-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-lightbulb text-primary"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <h6 class="mb-0 text-dark">${escapeHtml(skill.name)}</h6>
              <small class="text-muted">ID: ${skill.id}</small>
            </div>
          </div>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary flex-fill edit-skill-btn" 
              data-skill-id="${skill.id}" 
              data-skill-name="${escapeHtml(skill.name)}"
              data-category-id="${skill.categoryId || ''}">
              <i class="fas fa-edit"></i><span class="d-none d-md-inline ms-1">Edit</span>
            </button>
            <button class="btn btn-sm btn-outline-danger flex-fill delete-skill-btn"
              data-skill-id="${skill.id}"
              data-skill-name="${escapeHtml(skill.name)}">
              <i class="fas fa-trash"></i><span class="d-none d-md-inline ms-1">Delete</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  `).join('');

    // Attach event listeners to the newly created buttons
    attachSkillButtonListeners();
  }

  // Helper function to escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Attach event listeners to skill buttons
  function attachSkillButtonListeners() {
    // Edit skill buttons
    document.querySelectorAll('.edit-skill-btn').forEach(function (button) {
      button.addEventListener('click', function () {
        const skillId = this.getAttribute('data-skill-id');
        const skillName = this.getAttribute('data-skill-name');
        const categoryId = this.getAttribute('data-category-id');

        document.getElementById('editSkillName').value = skillName;
        document.getElementById('editSkillCategory').value = categoryId;
        document.getElementById('editSkillForm').action = '/admin/skills/' + skillId + '/update';

        // Close skills modal and open edit modal
        const skillsModal = bootstrap.Modal.getInstance(document.getElementById('skillsModal'));
        if (skillsModal) skillsModal.hide();

        const editModal = new bootstrap.Modal(document.getElementById('editSkillModal'));
        editModal.show();
      });
    });

    // Delete skill buttons
    document.querySelectorAll('.delete-skill-btn').forEach(function (button) {
      button.addEventListener('click', function () {
        const skillId = this.getAttribute('data-skill-id');
        const skillName = this.getAttribute('data-skill-name');

        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'Delete Skill?',
            text: `Are you sure you want to delete "${skillName}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it',
            cancelButtonText: 'Cancel'
          }).then((result) => {
            if (result.isConfirmed) {
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = '/admin/skills/' + skillId + '/delete';

              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = '_csrf';
              csrfInput.value = document.querySelector('input[name="_csrf"]').value;
              form.appendChild(csrfInput);

              document.body.appendChild(form);
              form.submit();
            }
          });
        } else {
          if (confirm(`Are you sure you want to delete "${skillName}"?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/skills/' + skillId + '/delete';

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = document.querySelector('input[name="_csrf"]').value;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
          }
        }
      });
    });
  }
</script>