<div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="h4 mb-0">Send Tip</h1>
    <a class="btn btn-outline-secondary" href="javascript:history.back()">Back</a>
</div>

<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <div class="row g-4">
                    <!-- Left Column: Recipient Info & Amount -->
                    <div class="col-md-5">
                        <div class="text-center mb-4 pb-3 border-bottom">
                            <% if (recipient.profileImage) { %>
                                <img src="<%= recipient.profileImage %>" alt="<%= recipient.name %>"
                                    class="rounded-circle mb-3 shadow-sm"
                                    style="width: 80px; height: 80px; object-fit: cover;">
                                <% } else { %>
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-3 shadow-sm"
                                        style="width: 80px; height: 80px;">
                                        <i class="fas fa-user fa-2x text-secondary"></i>
                                    </div>
                                    <% } %>
                                        <h5 class="mb-1">
                                            <%= recipient.name %>
                                        </h5>
                                        <p class="text-muted small mb-0">Show your appreciation!</p>
                        </div>

                        <form id="tip-form">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <input type="hidden" name="toUserId" value="<%= recipient.id %>">

                            <div class="mb-3">
                                <label class="form-label fw-semibold small text-uppercase text-muted">Quick
                                    Select</label>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-outline-primary amount-btn" data-amount="5">RM
                                        5</button>
                                    <button type="button" class="btn btn-outline-primary amount-btn" data-amount="10">RM
                                        10</button>
                                    <button type="button" class="btn btn-outline-primary amount-btn" data-amount="20">RM
                                        20</button>
                                    <button type="button" class="btn btn-outline-primary amount-btn" data-amount="50">RM
                                        50</button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold small text-uppercase text-muted">Custom
                                    Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">RM</span>
                                    <input type="number" class="form-control" id="amount" name="amount" min="1"
                                        max="500" step="1" required placeholder="Enter amount">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold small text-uppercase text-muted">Note
                                    (optional)</label>
                                <input type="text" class="form-control" id="note" name="note" maxlength="200"
                                    placeholder="Add a personal message...">
                            </div>
                    </div>

                    <!-- Right Column: Payment -->
                    <div class="col-md-7">
                        <div class="bg-light rounded p-3 h-100">
                            <!-- Quick Pay with Saved Cards -->
                            <% if (typeof savedCards !=='undefined' && savedCards && savedCards.length> 0) { %>
                                <div class="mb-4">
                                    <h6 class="text-uppercase small text-muted fw-semibold mb-3">
                                        <i class="fas fa-bolt me-2 text-warning"></i>Quick Pay
                                    </h6>
                                    <div class="d-flex flex-column gap-2" id="saved-cards">
                                        <% savedCards.forEach(card=> { %>
                                            <div class="card border saved-card-option" data-card-id="<%= card.id %>"
                                                style="cursor: pointer;">
                                                <div class="card-body py-2 px-3 d-flex align-items-center">
                                                    <i
                                                        class="fab fa-cc-<%= card.brand.toLowerCase() %> fa-2x text-primary me-3"></i>
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold text-uppercase small">
                                                            <%= card.brand %> •••• <%= card.last4 %>
                                                        </div>
                                                        <div class="text-muted small">Expires <%= card.expMonth %>/<%=
                                                                    card.expYear %>
                                                        </div>
                                                    </div>
                                                    <i
                                                        class="fas fa-check-circle text-success d-none card-selected-icon"></i>
                                                </div>
                                            </div>
                                            <% }) %>
                                    </div>
                                    <button type="button" class="btn btn-success w-100 mt-3" id="quick-pay-btn"
                                        disabled>
                                        <span id="quick-pay-text"><i class="fas fa-bolt me-2"></i>Quick Pay</span>
                                        <span id="quick-pay-spinner"
                                            class="spinner-border spinner-border-sm d-none"></span>
                                    </button>
                                    <div class="text-center mt-2">
                                        <small class="text-muted">or enter new card details below</small>
                                    </div>
                                </div>
                                <hr>
                                <% } %>

                                    <h6 class="mb-3 text-uppercase small text-muted fw-semibold">
                                        <i class="fas fa-lock me-2"></i>Payment Details
                                    </h6>

                                    <div id="payment-element" class="mb-3" style="min-height: 200px;">
                                        <div class="text-center py-5 text-muted">
                                            <i class="fas fa-arrow-left me-2"></i>Select an amount to continue
                                        </div>
                                    </div>

                                    <div id="error-message" class="alert alert-danger d-none small mb-3"></div>

                                    <button type="submit" class="btn btn-success w-100 btn-lg" id="submit-btn" disabled>
                                        <span id="button-text"><i class="fas fa-gift me-2"></i>Send Tip</span>
                                        <span id="spinner" class="spinner-border spinner-border-sm d-none"
                                            role="status"></span>
                                    </button>

                                    <div class="text-center mt-2 text-muted small">
                                        <i class="fas fa-shield-alt me-1"></i> Secure payment powered by Stripe
                                    </div>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const stripe = Stripe('<%= stripePublishableKey %>');
        const form = document.getElementById('tip-form');
        const submitBtn = document.getElementById('submit-btn');
        const amountInput = document.getElementById('amount');
        let elements;
        let clientSecret;

        // Amount quick select buttons
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                amountInput.value = this.dataset.amount;
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active', 'btn-primary'));
                document.querySelectorAll('.amount-btn').forEach(b => b.classList.add('btn-outline-primary'));
                this.classList.remove('btn-outline-primary');
                this.classList.add('active', 'btn-primary');
                initializePayment();
            });
        });

        amountInput.addEventListener('change', initializePayment);

        async function initializePayment() {
            const amount = amountInput.value;
            if (!amount || amount < 1) return;

            submitBtn.disabled = true;
            document.getElementById('payment-element').innerHTML = '<div class="text-center py-4"><span class="spinner-border spinner-border-sm text-primary"></span> Loading payment form...</div>';

            try {
                const response = await fetch('/tips/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'CSRF-Token': form.querySelector('[name="_csrf"]').value
                    },
                    body: JSON.stringify({
                        toUserId: form.querySelector('[name="toUserId"]').value,
                        amount: amount,
                        note: document.getElementById('note').value
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showError(data.error);
                    return;
                }

                clientSecret = data.clientSecret;

                const appearance = { theme: 'stripe', variables: { colorPrimary: '#198754' } };
                elements = stripe.elements({ appearance, clientSecret });

                const paymentElement = elements.create('payment', { layout: 'accordion' });
                document.getElementById('payment-element').innerHTML = '';
                paymentElement.mount('#payment-element');

                paymentElement.on('ready', () => {
                    submitBtn.disabled = false;
                });
            } catch (error) {
                showError('Failed to initialize payment');
                console.error(error);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!elements || !clientSecret) {
                showError('Please enter an amount first');
                return;
            }

            setLoading(true);

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.origin + '/tips?success=1',
                },
            });

            if (error) {
                showError(error.message);
                setLoading(false);
            }
        });

        function showError(msg) {
            const el = document.getElementById('error-message');
            el.textContent = msg;
            el.classList.remove('d-none');
            setTimeout(() => el.classList.add('d-none'), 5000);
        }

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            document.getElementById('spinner').classList.toggle('d-none', !isLoading);
            document.getElementById('button-text').classList.toggle('d-none', isLoading);
        }

        // Quick Pay functionality
        let selectedCardId = null;
        const savedCardOptions = document.querySelectorAll('.saved-card-option');
        const quickPayBtn = document.getElementById('quick-pay-btn');

        // Handle saved card selection
        savedCardOptions.forEach(card => {
            card.addEventListener('click', function () {
                // Remove selection from all cards
                savedCardOptions.forEach(c => {
                    c.classList.remove('border-success', 'bg-success-subtle');
                    c.querySelector('.card-selected-icon').classList.add('d-none');
                });

                // Select this card
                this.classList.add('border-success', 'bg-success-subtle');
                this.querySelector('.card-selected-icon').classList.remove('d-none');
                selectedCardId = this.dataset.cardId;

                // Enable quick pay button if amount is entered
                updateQuickPayButton();
            });
        });

        // Update quick pay button state
        function updateQuickPayButton() {
            if (quickPayBtn) {
                const amount = amountInput.value;
                quickPayBtn.disabled = !selectedCardId || !amount || amount < 1;
            }
        }

        // Listen for amount changes to update quick pay button
        amountInput.addEventListener('input', updateQuickPayButton);
        amountInput.addEventListener('change', updateQuickPayButton);

        // Handle quick pay button click
        if (quickPayBtn) {
            quickPayBtn.addEventListener('click', async function () {
                const amount = amountInput.value;
                if (!selectedCardId || !amount || amount < 1) {
                    showError('Please select a card and enter an amount');
                    return;
                }

                // Set loading state
                quickPayBtn.disabled = true;
                document.getElementById('quick-pay-text').classList.add('d-none');
                document.getElementById('quick-pay-spinner').classList.remove('d-none');

                try {
                    const response = await fetch('/tips/quick-pay', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'CSRF-Token': form.querySelector('[name="_csrf"]').value
                        },
                        body: JSON.stringify({
                            toUserId: form.querySelector('[name="toUserId"]').value,
                            amount: amount,
                            note: document.getElementById('note').value,
                            paymentMethodId: selectedCardId
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Show success with SweetAlert
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'success',
                                title: 'Tip Sent!',
                                text: data.message,
                                confirmButtonColor: '#198754'
                            }).then(() => {
                                window.location.href = '/tips?success=1';
                            });
                        } else {
                            alert(data.message);
                            window.location.href = '/tips?success=1';
                        }
                    } else {
                        showError(data.error || 'Payment failed');
                        // Reset button
                        quickPayBtn.disabled = false;
                        document.getElementById('quick-pay-text').classList.remove('d-none');
                        document.getElementById('quick-pay-spinner').classList.add('d-none');
                    }
                } catch (error) {
                    console.error('Quick pay error:', error);
                    showError('Payment failed. Please try again.');
                    quickPayBtn.disabled = false;
                    document.getElementById('quick-pay-text').classList.remove('d-none');
                    document.getElementById('quick-pay-spinner').classList.add('d-none');
                }
            });
        }
    });
</script>